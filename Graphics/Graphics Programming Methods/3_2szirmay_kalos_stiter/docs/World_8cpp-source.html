<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>World.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>World.cpp</h1><a href="World_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">// Graphics Programming Methods</span>
00003 <span class="comment">// An Effective kd-tree Implementation</span>
00004 <span class="comment">// László Szécsi</span>
00005 <span class="comment">// 2003.</span>
00006 
00007 <span class="comment">// several support classes used to build the virtual world</span>
00008 <span class="comment">// - basic Vector class with overloaded operators (used in KDTree)</span>
00009 <span class="comment">// - Ray and HitRec for ray-casting (used in KDTree)</span>
00010 <span class="comment">// - BoundingBox, Intersectable classes (used in KDTree)</span>
00011 <span class="comment">// - Triangle and Sphere descendants of Intersectable</span>
00012 <span class="comment">// - Light and Material classes for the virtual world</span>
00013 
00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00015 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00016 
00017 <span class="preprocessor">#include "<a class="code" href="World_8hpp.html">World.hpp</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="Matrix_8hpp.html">Matrix.hpp</a>"</span>
00019 
<a name="l00020"></a><a class="code" href="classIntersectable.html#p0">00020</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="classIntersectable.html#p0">Intersectable::gMaxIndex</a> = 0;
<a name="l00021"></a><a class="code" href="classRay.html#p0">00021</a> <span class="keywordtype">long</span> <a class="code" href="classRay.html#p0">Ray::maxRayID</a> = 0;
00022 
<a name="l00023"></a><a class="code" href="classIntersectable.html#a0">00023</a> <a class="code" href="classIntersectable.html#a0">Intersectable::Intersectable</a>(<span class="keyword">const</span> <a class="code" href="classMaterial.html">Material</a>* material): m_pMaterial(material)
00024 {
00025         <a class="code" href="classIntersectable.html#m2">lastTestedRayId</a> = 0;
00026 }
00027 
<a name="l00028"></a><a class="code" href="classIntersectable.html#a1">00028</a> <a class="code" href="classIntersectable.html#a1">Intersectable::~Intersectable</a>()
00029 {
00030 }
00031 
<a name="l00032"></a><a class="code" href="classTriangle.html#a1">00032</a> <a class="code" href="classTriangle.html#a0">Triangle::Triangle</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>* _a, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>* _b, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>* _c, <span class="keyword">const</span> <a class="code" href="classMaterial.html">Material</a>* _material)
00033                 :<a class="code" href="classIntersectable.html">Intersectable</a>(_material),a(_a),b(_b),c(_c)
00034 {
00035 }
00036 
00037 
<a name="l00038"></a><a class="code" href="classTriangle.html#a6">00038</a> <span class="keywordtype">void</span> <a class="code" href="classTriangle.html#a6">Triangle::Finish</a>() 
00039 {
00040         <span class="comment">// 1. calculate bounding box</span>
00041         <a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m0">minPoint</a> = *<a class="code" href="classTriangle.html#m0">a</a>;
00042         <a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m0">minPoint</a> &lt;= *<a class="code" href="classTriangle.html#m1">b</a>;
00043         <a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m0">minPoint</a> &lt;= *<a class="code" href="classTriangle.html#m2">c</a>;
00044 
00045         <a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m1">maxPoint</a> = *<a class="code" href="classTriangle.html#m0">a</a>;
00046         <a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m1">maxPoint</a> &gt;= *<a class="code" href="classTriangle.html#m1">b</a>;
00047         <a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m1">maxPoint</a> &gt;= *<a class="code" href="classTriangle.html#m2">c</a>;
00048 
00049         <a class="code" href="classTriangle.html#m4">midPoint</a> = (*<a class="code" href="classTriangle.html#m0">a</a> + *<a class="code" href="classTriangle.html#m1">b</a> + *<a class="code" href="classTriangle.html#m2">c</a>) * (1.0f /3.0f);
00050 
00051         assert(!_isnan(<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#m1">x</a>) &amp;&amp; !_isnan(<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#m2">y</a>) &amp;&amp; !_isnan(<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#m3">z</a>));
00052         <span class="keywordtype">double</span> dx = fabs (<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#m1">x</a>);
00053         <span class="keywordtype">double</span> dy = fabs (<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#m2">y</a>);
00054         <span class="keywordtype">double</span> dz = fabs (<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#m3">z</a>);
00055         <a class="code" href="classTriangle.html#z13_0">dominantAxis</a> = (dx &gt; dy) ? ((dx &gt; dz) ? <a class="code" href="globals_8hpp.html#a13a10">X_DOMINANT</a> : <a class="code" href="globals_8hpp.html#a13a12">Z_DOMINANT</a>) : ((dy &gt; dz) ? <a class="code" href="globals_8hpp.html#a13a11">Y_DOMINANT</a> : <a class="code" href="globals_8hpp.html#a13a12">Z_DOMINANT</a>);
00056 
00057         <a class="code" href="classTriangle.html#z13_1">hyperPlaneShiftOffset</a> = -1.0f * (<a class="code" href="classTriangle.html#m3">normal</a> * *<a class="code" href="classTriangle.html#m0">a</a>);
00058 
00059         <span class="keywordflow">switch</span> (dominantAxis) {
00060         <span class="keywordflow">case</span> <a class="code" href="globals_8hpp.html#a13a10">X_DOMINANT</a>:
00061                 <a class="code" href="classTriangle.html#z13_2">abV1</a>    = <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a> - <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00062                 <a class="code" href="classTriangle.html#z13_3">abV2</a>    = <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a> - <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00063                 <a class="code" href="classTriangle.html#z13_4">abC</a>             = <a class="code" href="classTriangle.html#z13_2">abV1</a> * <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a> + <a class="code" href="classTriangle.html#z13_3">abV2</a> * <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00064                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a> * <a class="code" href="classTriangle.html#z13_2">abV1</a> + <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a> * <a class="code" href="classTriangle.html#z13_3">abV2</a> &gt; <a class="code" href="classTriangle.html#z13_4">abC</a>) {
00065                         <a class="code" href="classTriangle.html#z13_4">abC</a>             *= -1.0;
00066                         <a class="code" href="classTriangle.html#z13_2">abV1</a>    *= -1.0;
00067                         <a class="code" href="classTriangle.html#z13_3">abV2</a>    *= -1.0;
00068                 }
00069 
00070                 <a class="code" href="classTriangle.html#z13_5">bcV1</a>    = <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a> - <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00071                 <a class="code" href="classTriangle.html#z13_6">bcV2</a>    = <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a> - <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00072                 <a class="code" href="classTriangle.html#z13_7">bcC</a>             = <a class="code" href="classTriangle.html#z13_5">bcV1</a> * <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a> + <a class="code" href="classTriangle.html#z13_6">bcV2</a> * <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00073                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a> * <a class="code" href="classTriangle.html#z13_5">bcV1</a> + <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a> * <a class="code" href="classTriangle.html#z13_6">bcV2</a> &gt; <a class="code" href="classTriangle.html#z13_7">bcC</a>) {
00074                         <a class="code" href="classTriangle.html#z13_7">bcC</a>             *= -1.0;
00075                         <a class="code" href="classTriangle.html#z13_5">bcV1</a>    *= -1.0;
00076                         <a class="code" href="classTriangle.html#z13_6">bcV2</a>    *= -1.0;
00077                 }
00078 
00079                 <a class="code" href="classTriangle.html#z13_8">caV1</a>    = <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a> - <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00080                 <a class="code" href="classTriangle.html#z13_9">caV2</a>    = <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a> - <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00081                 <a class="code" href="classTriangle.html#z13_10">caC</a>             = <a class="code" href="classTriangle.html#z13_8">caV1</a> * <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a> + <a class="code" href="classTriangle.html#z13_9">caV2</a> * <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00082                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a> * <a class="code" href="classTriangle.html#z13_8">caV1</a> + <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a> * <a class="code" href="classTriangle.html#z13_9">caV2</a> &gt; <a class="code" href="classTriangle.html#z13_10">caC</a>) {
00083                         <a class="code" href="classTriangle.html#z13_10">caC</a>             *= -1.0;
00084                         <a class="code" href="classTriangle.html#z13_8">caV1</a>    *= -1.0;
00085                         <a class="code" href="classTriangle.html#z13_9">caV2</a>    *= -1.0;
00086                 }
00087 
00088                 <span class="keywordflow">break</span>;
00089         <span class="keywordflow">case</span> <a class="code" href="globals_8hpp.html#a13a11">Y_DOMINANT</a>:
00090                 <a class="code" href="classTriangle.html#z13_2">abV1</a>    = <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a> - <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00091                 <a class="code" href="classTriangle.html#z13_3">abV2</a>    = <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a> - <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a>;
00092                 <a class="code" href="classTriangle.html#z13_4">abC</a>             = <a class="code" href="classTriangle.html#z13_2">abV1</a> * <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a> + <a class="code" href="classTriangle.html#z13_3">abV2</a> * <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00093                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a> * <a class="code" href="classTriangle.html#z13_2">abV1</a> + <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a> * <a class="code" href="classTriangle.html#z13_3">abV2</a> &gt; <a class="code" href="classTriangle.html#z13_4">abC</a>) {
00094                         <a class="code" href="classTriangle.html#z13_4">abC</a>             *= -1.0;
00095                         <a class="code" href="classTriangle.html#z13_2">abV1</a>    *= -1.0;
00096                         <a class="code" href="classTriangle.html#z13_3">abV2</a>    *= -1.0;
00097                 }
00098 
00099                 <a class="code" href="classTriangle.html#z13_5">bcV1</a>    = <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a> - <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00100                 <a class="code" href="classTriangle.html#z13_6">bcV2</a>    = <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a> - <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a>;
00101                 <a class="code" href="classTriangle.html#z13_7">bcC</a>             = <a class="code" href="classTriangle.html#z13_5">bcV1</a> * <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a> + <a class="code" href="classTriangle.html#z13_6">bcV2</a> * <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00102                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a> * <a class="code" href="classTriangle.html#z13_5">bcV1</a> + <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a> * <a class="code" href="classTriangle.html#z13_6">bcV2</a> &gt; <a class="code" href="classTriangle.html#z13_7">bcC</a>){
00103                         <a class="code" href="classTriangle.html#z13_7">bcC</a>             *= -1.0;
00104                         <a class="code" href="classTriangle.html#z13_5">bcV1</a>    *= -1.0;
00105                         <a class="code" href="classTriangle.html#z13_6">bcV2</a>    *= -1.0;
00106                 }
00107 
00108                 <a class="code" href="classTriangle.html#z13_8">caV1</a>    = <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a> - <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00109                 <a class="code" href="classTriangle.html#z13_9">caV2</a>    = <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a> - <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a>;
00110                 <a class="code" href="classTriangle.html#z13_10">caC</a>             = <a class="code" href="classTriangle.html#z13_8">caV1</a> * <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a> + <a class="code" href="classTriangle.html#z13_9">caV2</a> * <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a>;
00111                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a> * <a class="code" href="classTriangle.html#z13_8">caV1</a> + <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a> * <a class="code" href="classTriangle.html#z13_9">caV2</a> &gt; <a class="code" href="classTriangle.html#z13_10">caC</a>){
00112                         <a class="code" href="classTriangle.html#z13_10">caC</a>             *= -1.0;
00113                         <a class="code" href="classTriangle.html#z13_8">caV1</a>    *= -1.0;
00114                         <a class="code" href="classTriangle.html#z13_9">caV2</a>    *= -1.0;
00115                 }
00116                 <span class="keywordflow">break</span>;
00117         <span class="keywordflow">case</span> <a class="code" href="globals_8hpp.html#a13a12">Z_DOMINANT</a>:
00118                 <a class="code" href="classTriangle.html#z13_2">abV1</a>    = <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a> - <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00119                 <a class="code" href="classTriangle.html#z13_3">abV2</a>    = <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a> - <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a>;
00120                 <a class="code" href="classTriangle.html#z13_4">abC</a>             = <a class="code" href="classTriangle.html#z13_2">abV1</a> * <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a> + <a class="code" href="classTriangle.html#z13_3">abV2</a> * <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00121                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a> * <a class="code" href="classTriangle.html#z13_2">abV1</a> + <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a> * <a class="code" href="classTriangle.html#z13_3">abV2</a> &gt; <a class="code" href="classTriangle.html#z13_4">abC</a>) {
00122                         <a class="code" href="classTriangle.html#z13_4">abC</a>             *= -1.0;
00123                         <a class="code" href="classTriangle.html#z13_2">abV1</a>    *= -1.0;
00124                         <a class="code" href="classTriangle.html#z13_3">abV2</a>    *= -1.0;
00125                 }
00126 
00127                 <a class="code" href="classTriangle.html#z13_5">bcV1</a>    = <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a> - <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00128                 <a class="code" href="classTriangle.html#z13_6">bcV2</a>    = <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a> - <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a>;
00129                 <a class="code" href="classTriangle.html#z13_7">bcC</a>             = <a class="code" href="classTriangle.html#z13_5">bcV1</a> * <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a> + <a class="code" href="classTriangle.html#z13_6">bcV2</a> * <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00130                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a> * <a class="code" href="classTriangle.html#z13_5">bcV1</a> + <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a> * <a class="code" href="classTriangle.html#z13_6">bcV2</a> &gt; <a class="code" href="classTriangle.html#z13_7">bcC</a>) {
00131                         <a class="code" href="classTriangle.html#z13_7">bcC</a>             *= -1.0;
00132                         <a class="code" href="classTriangle.html#z13_5">bcV1</a>    *= -1.0;
00133                         <a class="code" href="classTriangle.html#z13_6">bcV2</a>    *= -1.0;
00134                 }
00135 
00136                 <a class="code" href="classTriangle.html#z13_8">caV1</a>    = <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a> - <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00137                 <a class="code" href="classTriangle.html#z13_9">caV2</a>    = <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a> - <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a>;
00138                 <a class="code" href="classTriangle.html#z13_10">caC</a>             = <a class="code" href="classTriangle.html#z13_8">caV1</a> * <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a> + <a class="code" href="classTriangle.html#z13_9">caV2</a> * <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a>;
00139                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a> * <a class="code" href="classTriangle.html#z13_8">caV1</a> + <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a> * <a class="code" href="classTriangle.html#z13_9">caV2</a> &gt; <a class="code" href="classTriangle.html#z13_10">caC</a>){
00140                         <a class="code" href="classTriangle.html#z13_10">caC</a>             *= -1.0;
00141                         <a class="code" href="classTriangle.html#z13_8">caV1</a>    *= -1.0;
00142                         <a class="code" href="classTriangle.html#z13_9">caV2</a>    *= -1.0;
00143                 }
00144                 <span class="keywordflow">break</span>;
00145         }
00146 }
00147 
<a name="l00148"></a><a class="code" href="classTriangle.html#a2">00148</a> <span class="keywordtype">bool</span> <a class="code" href="classTriangle.html#a2">Triangle::intersect</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a>&amp; ray, <span class="keywordtype">float</span>&amp; depth)
00149 {
00150         <a class="code" href="classIntersectable.html#m2">lastTestedRayId</a> = ray.<a class="code" href="classRay.html#m2">id</a>;
00151         <a class="code" href="classIntersectable.html#m3">lastTestedRayResult</a>.<a class="code" href="classHitRec.html#m3">isIntersect</a> = <span class="keyword">false</span>;
00152 
00153         <span class="keywordtype">double</span> cosa = <a class="code" href="classTriangle.html#m3">normal</a> * ray.<a class="code" href="classRay.html#m1">dir</a>;
00154         <span class="keywordflow">if</span> (cosa &gt; -1e-5F)      <span class="comment">// back facing patch</span>
00155                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00156 
00157         <span class="keywordtype">double</span> originDistOnNormal = <a class="code" href="classTriangle.html#m3">normal</a> * ray.<a class="code" href="classRay.html#m0">origin</a>;
00158         depth = (float)(-(<a class="code" href="classTriangle.html#z13_1">hyperPlaneShiftOffset</a> + originDistOnNormal) / cosa);
00159         <span class="keywordflow">if</span> (depth &lt; 0.0f)
00160                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00161 
00162         <span class="keywordtype">double</span> s, v;
00163         <span class="keywordflow">switch</span> (dominantAxis) {
00164         <span class="keywordflow">case</span> <a class="code" href="globals_8hpp.html#a13a10">X_DOMINANT</a>:
00165                 s = ray.<a class="code" href="classRay.html#m0">origin</a>.<a class="code" href="classVector.html#m2">y</a> + depth * ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#m2">y</a>;
00166                 v = ray.<a class="code" href="classRay.html#m0">origin</a>.<a class="code" href="classVector.html#m3">z</a> + depth * ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#m3">z</a>;
00167                 <span class="keywordflow">break</span>;
00168         <span class="keywordflow">case</span> <a class="code" href="globals_8hpp.html#a13a11">Y_DOMINANT</a>:
00169                 s = ray.<a class="code" href="classRay.html#m0">origin</a>.<a class="code" href="classVector.html#m1">x</a> + depth * ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#m1">x</a>;
00170                 v = ray.<a class="code" href="classRay.html#m0">origin</a>.<a class="code" href="classVector.html#m3">z</a> + depth * ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#m3">z</a>;
00171                 <span class="keywordflow">break</span>;
00172         <span class="keywordflow">case</span> <a class="code" href="globals_8hpp.html#a13a12">Z_DOMINANT</a>:
00173                 s = ray.<a class="code" href="classRay.html#m0">origin</a>.<a class="code" href="classVector.html#m1">x</a> + depth * ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#m1">x</a>;
00174                 v = ray.<a class="code" href="classRay.html#m0">origin</a>.<a class="code" href="classVector.html#m2">y</a> + depth * ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#m2">y</a>;
00175                 <span class="keywordflow">break</span>;
00176         }
00177 
00178         <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#z13_2">abV1</a> * s + <a class="code" href="classTriangle.html#z13_3">abV2</a> * v &gt; <a class="code" href="classTriangle.html#z13_4">abC</a>)
00179                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00180         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#z13_5">bcV1</a> * s + <a class="code" href="classTriangle.html#z13_6">bcV2</a> * v &gt; <a class="code" href="classTriangle.html#z13_7">bcC</a>)
00181                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00182         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#z13_8">caV1</a> * s + <a class="code" href="classTriangle.html#z13_9">caV2</a> * v &gt; <a class="code" href="classTriangle.html#z13_10">caC</a>)
00183                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00184 
00185         <a class="code" href="classIntersectable.html#m3">lastTestedRayResult</a>.<a class="code" href="classHitRec.html#m3">isIntersect</a> = <span class="keyword">true</span>;
00186         <a class="code" href="classIntersectable.html#m3">lastTestedRayResult</a>.<a class="code" href="classHitRec.html#m2">object</a>              = <span class="keyword">this</span>;
00187         <a class="code" href="classIntersectable.html#m3">lastTestedRayResult</a>.<a class="code" href="classHitRec.html#m1">depth</a>               = depth;
00188         <a class="code" href="classIntersectable.html#m3">lastTestedRayResult</a>.<a class="code" href="classHitRec.html#m0">point</a>               = ray.<a class="code" href="classRay.html#m0">origin</a> + ray.<a class="code" href="classRay.html#m1">dir</a> * depth;
00189         <span class="comment">//hitRec-&gt;point = ray.origin + ray.dir * t;     // calculate this just for the minimal Patch</span>
00190         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00191 }
00192 
00193 
<a name="l00194"></a><a class="code" href="classLightSourceSample.html#a2">00194</a> <span class="keywordtype">void</span> <a class="code" href="classLightSourceSample.html#a2">LightSourceSample::Init</a>(<a class="code" href="classLight.html">Light</a>* light, <span class="keywordtype">int</span> nSamples) 
00195 {
00196         <a class="code" href="classLightSourceSample.html#m0">m_pLight</a>=light;
00197         <a class="code" href="classLightSourceSample.html#m1">m_nSamples</a>=nSamples;
00198 
00199         <span class="keywordflow">if</span> (m_pLight) {
00200                 <span class="keywordflow">if</span> (samples) <span class="keyword">delete</span> <a class="code" href="classLightSourceSample.html#m2">samples</a>;
00201                 samples = <span class="keyword">new</span> <a class="code" href="classVector.html">Vector</a>[<a class="code" href="classLightSourceSample.html#m1">m_nSamples</a>];
00202                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classLightSourceSample.html#m1">m_nSamples</a>; j++) {
00203                         samples[j]=<a class="code" href="classLightSourceSample.html#m0">m_pLight</a>-&gt;<a class="code" href="classLight.html#m0">m_pPatch</a>-&gt;<a class="code" href="classTriangle.html#a5">PointInTriangle</a>();
00204                 }
00205         } <span class="keywordflow">else</span> {
00206                 <a class="code" href="classLightSourceSample.html#m0">m_pLight</a>=NULL;
00207         }
00208 }
00209 
00210 <span class="comment"></span>
00211 <span class="comment">//! simple triangle plane -- ray intersection calculation</span>
00212 <span class="comment"></span><span class="comment">/*! This is a simplified triangle-ray intersection calculation,</span>
00213 <span class="comment">basically calculating the ray-plane intersection point and its distance</span>
00214 <span class="comment">from the ray's origin.*/</span>
<a name="l00215"></a><a class="code" href="classPatch.html#a1">00215</a> <span class="keywordtype">bool</span> <a class="code" href="classPatch.html#a1">Patch::CalculateIntersection</a> (<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a>&amp; ray, <a class="code" href="classHitRec.html">HitRec</a>&amp; hr)
00216 {
00217         <span class="keywordtype">float</span> cosa = <a class="code" href="classTriangle.html#m3">normal</a> * ray.<a class="code" href="classRay.html#m1">dir</a>;
00218         <span class="comment">// back facing patch?</span>
00219         <span class="keywordflow">if</span> (cosa &gt; -<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) {
00220                 hr.<a class="code" href="classHitRec.html#m2">object</a>=NULL;
00221                 hr.<a class="code" href="classHitRec.html#m3">isIntersect</a>=<span class="keyword">false</span>;
00222                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00223         }
00224 
00225         <span class="keywordtype">float</span> originDistOnNormal = <a class="code" href="classTriangle.html#m3">normal</a> * ray.<a class="code" href="classRay.html#m0">origin</a>;
00226         hr.<a class="code" href="classHitRec.html#m1">depth</a> = -(<a class="code" href="classTriangle.html#z13_1">hyperPlaneShiftOffset</a> + originDistOnNormal) / cosa;
00227         hr.<a class="code" href="classHitRec.html#m0">point</a> = ray.<a class="code" href="classRay.html#m0">origin</a> + ray.<a class="code" href="classRay.html#m1">dir</a> * hr.<a class="code" href="classHitRec.html#m1">depth</a>;
00228         hr.<a class="code" href="classHitRec.html#m2">object</a>= <span class="keyword">this</span>;
00229         hr.<a class="code" href="classHitRec.html#m3">isIntersect</a>=<span class="keyword">true</span>;
00230         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00231 }
00232 
00233 
<a name="l00234"></a><a class="code" href="classTriangle.html#a3">00234</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="classTriangle.html#a3">Triangle::getShadingNormal</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; point) 
00235 {
00236         <a class="code" href="classVector.html">Vector</a> pointShadingNormal;
00237 
00238         <a class="code" href="classMatrix3x3.html">Matrix3x3</a> m, mInv;
00239         <a class="code" href="classVector.html">Vector</a> weights;
00240 
00241         m.<a class="code" href="classMatrix3x3.html#a0">Fill</a> (<a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a>, <a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a>, <a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a>);
00242         mInv.<a class="code" href="classMatrix3x3.html#a1">InvertMatrix3x3</a> (m);
00243         <span class="keywordflow">if</span> (_finite(mInv.<a class="code" href="classMatrix3x3.html#m0">m</a>[0][0])) {    <span class="comment">// if it is a full rank matrix</span>
00244                 mInv.<a class="code" href="classMatrix3x3.html#a2">MultiplyMatrixLeft</a> (&amp;point, &amp;weights);
00245                 pointShadingNormal = *<a class="code" href="classTriangle.html#m5">Na</a> * weights.<a class="code" href="classVector.html#m1">x</a> + *<a class="code" href="classTriangle.html#m6">Nb</a> * weights.<a class="code" href="classVector.html#m2">y</a> + *<a class="code" href="classTriangle.html#m7">Nc</a> * weights.<a class="code" href="classVector.html#m3">z</a>;
00246         } <span class="keywordflow">else</span> {        
00247                 <span class="comment">// if the rank of m less than 3</span>
00248                 <span class="comment">// or it is possible to measure the distances of the point to vertices, and make a</span>
00249                 <span class="comment">// the weight according to the relative distances</span>
00250                 pointShadingNormal =  (*<a class="code" href="classTriangle.html#m5">Na</a> + *<a class="code" href="classTriangle.html#m6">Nb</a>+ *<a class="code" href="classTriangle.html#m7">Nc</a>)*(1.0f/3.0f);
00251         }
00252         pointShadingNormal.<a class="code" href="classVector.html#a20">Normalize</a>();
00253 
00254         <span class="keywordflow">return</span> pointShadingNormal;
00255 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Feb 18 18:30:34 2003 for Stochastic Iteration for Non-diffuse Global Illumination by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
