<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>scene.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>scene.cpp</h1><a href="scene_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;string.h&gt;</span>
00002 <span class="preprocessor">#include &lt;direct.h&gt;</span>
00003 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00004 
00005 <span class="preprocessor">#include "<a class="code" href="scene_8hpp.html">scene.hpp</a>"</span>
00006 
<a name="l00007"></a><a class="code" href="classScene.html#a0">00007</a> <a class="code" href="classScene.html#a0">Scene::Scene</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* lpszFileName, <span class="keywordtype">long</span> samplesPerLight)
00008 : m_samplesPerLight(samplesPerLight)
00009 {
00010         <a class="code" href="classScene.html#m2">m_pKDTree</a> = NULL;
00011 
00012         <a class="code" href="classScene.html#z1_0">sceneVertices</a>=NULL;
00013         <a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a>=NULL;
00014         <a class="code" href="classScene.html#z1_2">nSceneVertices</a>=0;
00015 
00016         <a class="code" href="classScene.html#z3_0">scenePatches</a>=NULL;
00017         <a class="code" href="classScene.html#z3_1">nScenePatches</a>=0;
00018 
00019         <a class="code" href="classScene.html#z5_0">sceneMaterials</a>=NULL;
00020         <a class="code" href="classScene.html#z5_1">nSceneMaterials</a>=0;
00021 
00022         <a class="code" href="classScene.html#z11_0">sceneLights</a>=NULL;
00023         <a class="code" href="classScene.html#z11_1">nSceneLights</a>=0;
00024 
00025         <a class="code" href="classScene.html#m0">sceneFileName</a>[0]=0;
00026 
00027         <a class="code" href="classScene.html#z7_0">Brdfs</a>=NULL;
00028         <a class="code" href="classScene.html#z7_1">nBrdf</a>=0;
00029 
00030         <a class="code" href="classScene.html#z9_0">Edfs</a>=NULL;
00031         <a class="code" href="classScene.html#z9_1">nEdf</a>=0;
00032 
00033         printf(<span class="stringliteral">"Loading %s ... "</span>, lpszFileName);
00034         <a class="code" href="classScene.html#b0">Read</a>(lpszFileName);
00035         printf(<span class="stringliteral">"Done.\n"</span>);
00036 
00037         <a class="code" href="classScene.html#b1">FinishInitializeScene</a>();
00038 
00039 <span class="comment">//      sceneFileName</span>
00040         <span class="keywordtype">char</span> drive[_MAX_DRIVE];
00041         <span class="keywordtype">char</span> dir[_MAX_DIR];
00042         <span class="keywordtype">char</span> fname[_MAX_FNAME];
00043         <span class="keywordtype">char</span> ext[_MAX_EXT];
00044         _splitpath( lpszFileName, drive, dir, fname, ext );
00045         _makepath( sceneFileName, drive, dir, fname, <span class="stringliteral">""</span>);
00046 };
00047 
00048 <span class="comment"></span>
00049 <span class="comment">//!     put area light sources to light source list</span>
<a name="l00050"></a><a class="code" href="classScene.html#b2">00050</a> <span class="comment"></span><span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classScene.html#b2">Scene::FinishLights</a> (<span class="keywordtype">long</span> numSceneLights)
00051 {
00052         <a class="code" href="classScene.html#z11_1">nSceneLights</a> = numSceneLights;
00053         <a class="code" href="classScene.html#z11_0">sceneLights</a> = <span class="keyword">new</span> <a class="code" href="classLight.html">Light</a>[<a class="code" href="classScene.html#z11_1">nSceneLights</a>];
00054         
00055         <span class="keywordtype">long</span> j=0;
00056         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i=0; i&lt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>; i++) {
00057                 <a class="code" href="classPatch.html">Patch</a>* pPatch = &amp;(<a class="code" href="classScene.html#z3_0">scenePatches</a> [i]);
00058                 <span class="keywordflow">if</span> (pPatch-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a> != NULL) {
00059                         <a class="code" href="classScene.html#z11_0">sceneLights</a> [j++].<a class="code" href="classLight.html#a1">Init</a>(pPatch, m_samplesPerLight);
00060                 }
00061         }
00062 }
00063 <span class="comment"></span>
00064 <span class="comment">//! Perform the final steps of scene initialization</span>
<a name="l00065"></a><a class="code" href="classScene.html#b1">00065</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classScene.html#b1">Scene::FinishInitializeScene</a>()
00066 {
00067         <a class="code" href="classScene.html#z11_1">nSceneLights</a> = 0;
00068         <a class="code" href="classIntersectable.html">Intersectable</a>** objects = <span class="keyword">new</span> <a class="code" href="classIntersectable.html">Intersectable</a>*[<a class="code" href="classScene.html#z3_1">nScenePatches</a>];
00069         <a class="code" href="classIntersectable.html#p0">Patch::gMaxIndex</a> = 0;
00070         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> j=0; j&lt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>; j++) {
00071                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classIntersectable.html#m4">m_index</a> = <a class="code" href="classIntersectable.html#p0">Patch::gMaxIndex</a>++;
00072                 objects[j]=&amp;(<a class="code" href="classScene.html#z3_0">scenePatches</a>[j]);
00073                 <span class="keywordflow">if</span> (scenePatches[j].m_pMaterial-&gt;m_edf != NULL) 
00074                         <a class="code" href="classScene.html#z11_1">nSceneLights</a>++;
00075         }
00076 
00077         <a class="code" href="classScene.html#m2">m_pKDTree</a> = <span class="keyword">new</span> <a class="code" href="classKDTree.html">KDTree</a>(objects, nScenePatches);
00078         <span class="keyword">delete</span> objects;
00079 
00080         <a class="code" href="classScene.html#b2">FinishLights</a> (nSceneLights);
00081 }
00082 
<a name="l00083"></a><a class="code" href="classScene.html#a1">00083</a> <a class="code" href="classScene.html#a1">Scene::~Scene</a>()
00084 {
00085         <span class="keywordflow">if</span> (<a class="code" href="classScene.html#z1_0">sceneVertices</a> != NULL)
00086                 <span class="keyword">delete</span>[] <a class="code" href="classScene.html#z1_0">sceneVertices</a>;
00087 
00088         <span class="keywordflow">if</span> (<a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a> != NULL)
00089                 <span class="keyword">delete</span>[] <a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a>;
00090 
00091         <span class="keywordflow">if</span> (<a class="code" href="classScene.html#z3_0">scenePatches</a> != NULL)
00092                 <span class="keyword">delete</span>[] <a class="code" href="classScene.html#z3_0">scenePatches</a>;
00093 
00094         <span class="keywordflow">if</span> (sceneMaterials)
00095                 <span class="keyword">delete</span>[] <a class="code" href="classScene.html#z5_0">sceneMaterials</a>;
00096 
00097         <span class="keywordflow">if</span> (Brdfs) 
00098                 <span class="keyword">delete</span>[] <a class="code" href="classScene.html#z7_0">Brdfs</a>;
00099 
00100         <span class="keywordflow">if</span> (Edfs) 
00101                 <span class="keyword">delete</span>[] <a class="code" href="classScene.html#z9_0">Edfs</a>;
00102 
00103         <span class="keywordflow">if</span> (<a class="code" href="classScene.html#z11_0">sceneLights</a> != NULL)
00104                 <span class="keyword">delete</span>[] <a class="code" href="classScene.html#z11_0">sceneLights</a>;
00105 
00106         <span class="keywordflow">if</span> (m_pKDTree) <span class="keyword">delete</span> <a class="code" href="classScene.html#m2">m_pKDTree</a>;
00107 }
00108 
<a name="l00109"></a><a class="code" href="scene_8cpp.html#a0">00109</a> <span class="keywordtype">char</span>*   <a class="code" href="scene_8cpp.html#a0">readBuffer</a>              = NULL;
<a name="l00110"></a><a class="code" href="scene_8cpp.html#a1">00110</a> size_t  <a class="code" href="scene_8cpp.html#a1">readBufferSize</a>  = 0;
<a name="l00111"></a><a class="code" href="scene_8cpp.html#a2">00111</a> size_t  <a class="code" href="scene_8cpp.html#a2">readBufferPos</a>   = 0;
00112 
<a name="l00113"></a><a class="code" href="scene_8cpp.html#a3">00113</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="scene_8cpp.html#a3">WriteVector</a>(FILE* file, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; v)
00114 {
00115         <span class="keywordtype">char</span> s[512];
00116         sprintf(s, <span class="stringliteral">"%f %f %f\n"</span>, v.<a class="code" href="classVector.html#m1">x</a>, v.<a class="code" href="classVector.html#m2">y</a>, v.<a class="code" href="classVector.html#m3">z</a>);
00117         fwrite(s, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), strlen(s), file);
00118 }
00119 
<a name="l00120"></a><a class="code" href="scene_8cpp.html#a4">00120</a> <span class="keyword">static</span> <a class="code" href="classVector.html">Vector</a> <a class="code" href="scene_8cpp.html#a4">ReadVector</a>(<span class="keywordtype">void</span>)
00121 {
00122         <span class="keywordtype">char</span>* cp = strchr(readBuffer + readBufferPos, <span class="charliteral">'\n'</span>);
00123         cp[0] = <span class="charliteral">'\0'</span>;
00124 
00125         <a class="code" href="classVector.html">Vector</a> v;
00126         sscanf(readBuffer + readBufferPos, <span class="stringliteral">"%f %f %f"</span>, &amp;v.<a class="code" href="classVector.html#m1">x</a>, &amp;v.<a class="code" href="classVector.html#m2">y</a>, &amp;v.<a class="code" href="classVector.html#m3">z</a>);
00127 
00128         <a class="code" href="scene_8cpp.html#a2">readBufferPos</a> += strlen(readBuffer + readBufferPos) + 1;
00129         <span class="keywordflow">return</span> v;
00130 }
00131 
<a name="l00132"></a><a class="code" href="scene_8cpp.html#a5">00132</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="scene_8cpp.html#a5">WriteColor</a>(FILE* file, <span class="keyword">const</span> <a class="code" href="classVector.html">Color</a>&amp; c)
00133 {
00134         <span class="keywordtype">char</span> s[512];
00135         sprintf(s, <span class="stringliteral">"%f %f %f\n"</span>, c.<a class="code" href="classVector.html#m4">r</a>, c.<a class="code" href="classVector.html#m5">g</a>, c.<a class="code" href="classVector.html#m6">b</a>);
00136         fwrite(s, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), strlen(s), file);
00137 }
00138 
<a name="l00139"></a><a class="code" href="scene_8cpp.html#a6">00139</a> <span class="keyword">static</span> <a class="code" href="classVector.html">Color</a> <a class="code" href="scene_8cpp.html#a6">ReadColor</a>(<span class="keywordtype">void</span>)
00140 {
00141         <span class="keywordtype">char</span>* cp = strchr(readBuffer + readBufferPos, <span class="charliteral">'\n'</span>);
00142         cp[0] = <span class="charliteral">'\0'</span>;
00143 
00144         <span class="keywordtype">float</span> r, g, b;
00145         sscanf(readBuffer + readBufferPos, <span class="stringliteral">"%f %f %f"</span>, &amp;r, &amp;g, &amp;b);
00146 
00147         <a class="code" href="scene_8cpp.html#a2">readBufferPos</a> += strlen(readBuffer + readBufferPos) + 1;
00148         <span class="keywordflow">return</span> <a class="code" href="Vector_8hpp.html#a0">Color</a>(r, g, b);
00149 }
00150 
<a name="l00151"></a><a class="code" href="scene_8cpp.html#a7">00151</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="scene_8cpp.html#a7">WriteDouble</a>(FILE* file, <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; f)
00152 {
00153         <span class="keywordtype">char</span> s[512];
00154         sprintf(s, <span class="stringliteral">"%f\n"</span>, f);
00155         fwrite(s, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), strlen(s), file);
00156 }
00157 
<a name="l00158"></a><a class="code" href="scene_8cpp.html#a8">00158</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="scene_8cpp.html#a8">ReadDouble</a>(<span class="keywordtype">void</span>)
00159 {
00160         <span class="keywordtype">char</span>* cp = strchr(readBuffer + readBufferPos, <span class="charliteral">'\n'</span>);
00161         cp[0] = <span class="charliteral">'\0'</span>;
00162 
00163         <span class="keywordtype">float</span> f;
00164         sscanf(readBuffer + readBufferPos, <span class="stringliteral">"%f"</span>, &amp;f);
00165 
00166         <a class="code" href="scene_8cpp.html#a2">readBufferPos</a> += strlen(readBuffer + readBufferPos) + 1;
00167         <span class="keywordflow">return</span> f;
00168 }
00169 
<a name="l00170"></a><a class="code" href="scene_8cpp.html#a9">00170</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="scene_8cpp.html#a9">WriteInt</a>(FILE* file, <span class="keywordtype">int</span> d)
00171 {
00172         <span class="keywordtype">char</span> s[512];
00173         sprintf(s, <span class="stringliteral">"%d\n"</span>, d);
00174         fwrite(s, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), strlen(s), file);
00175 }
00176 
<a name="l00177"></a><a class="code" href="scene_8cpp.html#a10">00177</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="scene_8cpp.html#a10">ReadInt</a>(<span class="keywordtype">void</span>)
00178 {
00179         <span class="keywordtype">char</span>* cp = strchr(readBuffer + readBufferPos, <span class="charliteral">'\n'</span>);
00180         cp[0] = <span class="charliteral">'\0'</span>;
00181 
00182         <span class="keywordtype">int</span> d;
00183         sscanf(readBuffer + readBufferPos, <span class="stringliteral">"%d"</span>, &amp;d);
00184 
00185         <a class="code" href="scene_8cpp.html#a2">readBufferPos</a> += strlen(readBuffer + readBufferPos) + 1;
00186         <span class="keywordflow">return</span> d;
00187 }
00188 
00189 
<a name="l00190"></a><a class="code" href="scene_8cpp.html#a11">00190</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="scene_8cpp.html#a11">WriteString</a>(FILE* file, <span class="keyword">const</span> <span class="keywordtype">char</span>* s)
00191 {
00192         fwrite(s, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), strlen(s), file);
00193 }
00194 
<a name="l00195"></a><a class="code" href="scene_8cpp.html#a12">00195</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="scene_8cpp.html#a12">ReadString</a>(<span class="keywordtype">char</span>* s)
00196 {
00197         <span class="keywordtype">char</span>* cp = strchr(readBuffer + readBufferPos, <span class="charliteral">'\n'</span>);
00198         cp[0] = <span class="charliteral">'\0'</span>;
00199         strcpy(s, readBuffer + readBufferPos);
00200         <a class="code" href="scene_8cpp.html#a2">readBufferPos</a> += strlen(readBuffer + readBufferPos) + 1;
00201 }
00202 
00203 
<a name="l00204"></a><a class="code" href="classScene.html#b0">00204</a> <span class="keywordtype">void</span> <a class="code" href="classScene.html#b0">Scene::Read</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* path)
00205 {
00206         FILE* file = fopen(path, <span class="stringliteral">"r+t"</span>);
00207         <span class="keywordflow">if</span> (file==NULL) {
00208                 printf(<span class="stringliteral">"ERROR: unable to open file '%s'\n"</span>, path);
00209                 exit(-1);
00210         }
00211 
00212         <span class="keywordtype">long</span> result = fseek(file, 0, SEEK_END);
00213         <span class="keywordtype">long</span> fSize = ftell(file);
00214         fseek (file, 0, SEEK_SET); 
00215 
00216         <a class="code" href="scene_8cpp.html#a0">readBuffer</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[fSize];
00217         <a class="code" href="scene_8cpp.html#a1">readBufferSize</a> = fread(readBuffer, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), fSize, file);
00218 
00219         <span class="keywordtype">char</span> s[512];
00220         <span class="comment">// camera</span>
00221         <a class="code" href="scene_8cpp.html#a12">ReadString</a>(s);
00222         <a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m0">eyep</a>   = <a class="code" href="scene_8cpp.html#a4">ReadVector</a>();
00223         <a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m2">updir</a>  = <a class="code" href="scene_8cpp.html#a4">ReadVector</a>();
00224         <a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m1">lookp</a>  = <a class="code" href="scene_8cpp.html#a4">ReadVector</a>();
00225         <a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m4">fov</a>    = (float)<a class="code" href="scene_8cpp.html#a8">ReadDouble</a>();
00226         <a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#a1">CompleteCamera</a> ();
00227 
00228         <a class="code" href="scene_8cpp.html#a12">ReadString</a>(s); <span class="comment">//"Materials\n");</span>
00229         <a class="code" href="classScene.html#z9_1">nEdf</a> = <a class="code" href="classScene.html#z7_1">nBrdf</a> = <a class="code" href="classScene.html#z5_1">nSceneMaterials</a> = <a class="code" href="scene_8cpp.html#a10">ReadInt</a>();
00230         <a class="code" href="classScene.html#z7_0">Brdfs</a> = <span class="keyword">new</span> <a class="code" href="classCPhongBrdf.html">CPhongBrdf</a>[nBrdf];
00231         <a class="code" href="classScene.html#z9_0">Edfs</a> = <span class="keyword">new</span> <a class="code" href="classCPhongEdf.html">CPhongEdf</a>[<a class="code" href="classScene.html#z9_1">nEdf</a>];
00232         <a class="code" href="classScene.html#z5_0">sceneMaterials</a> = <span class="keyword">new</span> <a class="code" href="classMaterial.html">Material</a>[nSceneMaterials];
00233 
00234         <span class="keywordtype">long</span> i;
00235         <span class="keywordflow">for</span> (i=0; i &lt; nBrdf; i++) {
00236                 <a class="code" href="classScene.html#z7_0">Brdfs</a>[i].<a class="code" href="classCPhongBrdf.html#m0">Kd</a> = <a class="code" href="scene_8cpp.html#a6">ReadColor</a>();      <span class="comment">// diffuseAlbedo</span>
00237                 <a class="code" href="classScene.html#z7_0">Brdfs</a>[i].<a class="code" href="classCPhongBrdf.html#m1">Ks</a> = <a class="code" href="scene_8cpp.html#a6">ReadColor</a>();      <span class="comment">// specularAlbedo</span>
00238                 <a class="code" href="classScene.html#z7_0">Brdfs</a>[i].<a class="code" href="classCPhongBrdf.html#m4">Ns</a> = (float)<a class="code" href="scene_8cpp.html#a8">ReadDouble</a>();      <span class="comment">// shine</span>
00239                 <a class="code" href="classScene.html#z9_0">Edfs</a>[i].<a class="code" href="classCPhongEdf.html#m1">kd</a> =  <a class="code" href="scene_8cpp.html#a6">ReadColor</a>();      <span class="comment">// diffuse radiosity</span>
00240 
00241                 <a class="code" href="classScene.html#z5_0">sceneMaterials</a>[i].<a class="code" href="classMaterial.html#m0">m_brdf</a> = &amp;<a class="code" href="classScene.html#z7_0">Brdfs</a>[i];
00242                 <span class="keywordflow">if</span> (<a class="code" href="classScene.html#z9_0">Edfs</a>[i].<a class="code" href="classCPhongEdf.html#m1">kd</a>.<a class="code" href="classVector.html#a28">Average</a>()&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) <a class="code" href="classScene.html#z5_0">sceneMaterials</a>[i].<a class="code" href="classMaterial.html#m1">m_edf</a> = NULL;
00243                 <span class="keywordflow">else</span> <a class="code" href="classScene.html#z5_0">sceneMaterials</a>[i].<a class="code" href="classMaterial.html#m1">m_edf</a> = &amp;<a class="code" href="classScene.html#z9_0">Edfs</a>[i];
00244 
00245                 <a class="code" href="classScene.html#z7_0">Brdfs</a>[i].<a class="code" href="classCPhongBrdf.html#a16">FinishPhong</a>();
00246                 <a class="code" href="classScene.html#z9_0">Edfs</a>[i].<a class="code" href="classCPhongEdf.html#a0">FinishPhong</a>();
00247         }
00248 
00249         <span class="comment">// vertices</span>
00250         <a class="code" href="scene_8cpp.html#a12">ReadString</a>(s); <span class="comment">//"vertices\n");</span>
00251         <a class="code" href="classScene.html#z1_2">nSceneVertices</a> = <a class="code" href="scene_8cpp.html#a10">ReadInt</a>();
00252         <a class="code" href="classScene.html#z1_0">sceneVertices</a> = <span class="keyword">new</span> <a class="code" href="classVector.html">Vector</a>[<a class="code" href="classScene.html#z1_2">nSceneVertices</a>];
00253         <a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a> = <span class="keyword">new</span> Vector[<a class="code" href="classScene.html#z1_2">nSceneVertices</a>];
00254         <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="classScene.html#z1_2">nSceneVertices</a>; i++) {
00255                 <a class="code" href="classScene.html#z1_0">sceneVertices</a>[i] = <a class="code" href="scene_8cpp.html#a4">ReadVector</a>();
00256                 <a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a>[i].<a class="code" href="classVector.html#a2">Set</a>(0.0f, 0.0f, 0.0f);
00257         }
00258 
00259 
00260         <span class="comment">// objects</span>
00261         <a class="code" href="scene_8cpp.html#a12">ReadString</a>(s); <span class="comment">//"objects\n");</span>
00262         <a class="code" href="classScene.html#z3_1">nScenePatches</a> = <a class="code" href="scene_8cpp.html#a10">ReadInt</a>();
00263         <a class="code" href="classScene.html#z3_0">scenePatches</a> = <span class="keyword">new</span> <a class="code" href="classPatch.html">Patch</a>[<a class="code" href="classScene.html#z3_1">nScenePatches</a>];
00264         <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="classScene.html#z3_1">nScenePatches</a>; i++) {
00265                 <span class="keywordtype">long</span> materialInd = <a class="code" href="scene_8cpp.html#a10">ReadInt</a>();
00266 
00267                 <span class="keywordtype">long</span> ai = <a class="code" href="scene_8cpp.html#a10">ReadInt</a>();
00268                 <span class="keywordtype">long</span> bi = <a class="code" href="scene_8cpp.html#a10">ReadInt</a>();
00269                 <span class="keywordtype">long</span> ci = <a class="code" href="scene_8cpp.html#a10">ReadInt</a>();
00270                 <a class="code" href="scene_8cpp.html#a12">ReadString</a>(s); <span class="comment">//"---\n");</span>
00271 
00272                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m0">a</a> = &amp;<a class="code" href="classScene.html#z1_0">sceneVertices</a>[ai];
00273                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m5">Na</a> = &amp;<a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a>[ai];
00274 
00275                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m1">b</a> = &amp;<a class="code" href="classScene.html#z1_0">sceneVertices</a>[bi];
00276                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m6">Nb</a> = &amp;<a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a>[bi];
00277 
00278                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m2">c</a> = &amp;<a class="code" href="classScene.html#z1_0">sceneVertices</a>[ci];
00279                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m7">Nc</a> = &amp;<a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a>[ci];
00280 
00281                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a> = &amp;<a class="code" href="classScene.html#z5_0">sceneMaterials</a>[materialInd];
00282 
00283                 <span class="comment">// 2. calculate normal</span>
00284                 Vector va = <a class="code" href="classScene.html#z1_0">sceneVertices</a>[bi] - sceneVertices[ai]; 
00285                 Vector vb = sceneVertices[ci] - sceneVertices[bi];
00286                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a> = va &amp;&amp; vb;      <span class="comment">//cross product</span>
00287                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#a20">Normalize</a>();
00288         }
00289 
00290         fclose(file);
00291 
00292         <span class="comment">// finishScene</span>
00293         <span class="keywordflow">for</span> (i = 0; i &lt; nScenePatches; i++) {
00294                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#a6">Finish</a>();
00295                 <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#a4">CalculateArea</a> ();
00296         }
00297 
00298         <span class="comment">// compute shading normals of vertices</span>
00299         <span class="keywordflow">for</span> (i = 0; i &lt; nScenePatches; i++) {
00300                 *<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m5">Na</a> += <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a>;
00301                 *<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m6">Nb</a> += <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a>;
00302                 *<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m7">Nc</a> += <a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a>;
00303         }
00304 
00305         <span class="keywordflow">for</span> (i = 0; i &lt; nSceneVertices; i++)
00306                 <a class="code" href="classScene.html#z1_1">sceneVerticesNormals</a>[i].<a class="code" href="classVector.html#a20">Normalize</a>();
00307 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Feb 18 18:30:34 2003 for Stochastic Iteration for Non-diffuse Global Illumination by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
