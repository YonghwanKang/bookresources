<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SelectionTree.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>SelectionTree.cpp</h1><a href="SelectionTree_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="SelectionTree_8hpp.html">SelectionTree.hpp</a>"</span>
00002 
00003 
00004 
<a name="l00005"></a><a class="code" href="classSelectionTree.html#a0">00005</a> <a class="code" href="classSelectionTree.html#a0">SelectionTree::SelectionTree</a>() {        
00006         <a class="code" href="classSelectionTree.html#n3">m_pScenePatches</a> = NULL;
00007         <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a> = NULL;
00008 
00009         <a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a> = <a class="code" href="classSelectionTree.html#n1">m_nElements</a> = 0;
00010 }
00011 
00012 
<a name="l00013"></a><a class="code" href="classSelectionTree.html#a1">00013</a> <a class="code" href="classSelectionTree.html#a1">SelectionTree::~SelectionTree</a>()
00014 {
00015         <span class="keywordflow">if</span> (m_TreeElements)
00016                 <span class="keyword">delete</span> <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>;
00017 }
00018 
00019 
<a name="l00020"></a><a class="code" href="classSelectionTree.html#a2">00020</a> <span class="keywordtype">void</span> <a class="code" href="classSelectionTree.html#a2">SelectionTree::Build</a>(<a class="code" href="classPatch.html">Patch</a>* scenePatches, <span class="keywordtype">long</span> nScenePatches)
00021 {
00022         <a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a> = nScenePatches;
00023         <a class="code" href="classSelectionTree.html#n3">m_pScenePatches</a> = scenePatches;
00024 
00025         <span class="comment">// calculate the depth of the tree</span>
00026     <span class="keywordtype">long</span> j=<a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a>;
00027         <span class="keywordtype">long</span> log2=0;
00028         <span class="keywordflow">while</span> (j &gt;0) {
00029                 log2++;
00030                 j=j&gt;&gt;1;
00031         }
00032 
00033         <span class="keywordtype">long</span> elements = (1 &lt;&lt; log2) -1;
00034         <span class="keywordflow">if</span> (<a class="code" href="classSelectionTree.html#n1">m_nElements</a>!=elements) {
00035                 <span class="keywordflow">if</span> (m_TreeElements) 
00036                         <span class="keyword">delete</span> <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>;
00037                 <a class="code" href="classSelectionTree.html#n1">m_nElements</a>=elements;
00038                 m_TreeElements = <span class="keyword">new</span> <a class="code" href="classTreeElement.html">TreeElement</a>[<a class="code" href="classSelectionTree.html#n1">m_nElements</a>];
00039         }
00040 
00041         <span class="comment">//reset the array by clearing the elements</span>
00042         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i=0; i&lt;<a class="code" href="classSelectionTree.html#n1">m_nElements</a>; i++) {
00043                 <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>[i].<a class="code" href="classTreeElement.html#a5">clear</a>();
00044         };
00045 
00046         <span class="keywordtype">long</span> k=(1&lt;&lt;(log2-1))-1;
00047 
00048         <a class="code" href="classTreeElement.html">TreeElement</a> tmp1, tmp2;
00049         <span class="comment">// calculate the leaves of the tree based on the patches</span>
00050         <span class="keywordflow">for</span> (i=0; i&lt;m_nScenePatches; i+=2) {
00051                 <span class="keywordflow">if</span> (i&lt;m_nScenePatches) {
00052                         <a class="code" href="classSelectionTree.html#a5">fillElement</a>(i, tmp1);
00053                 } <span class="keywordflow">else</span> {
00054                         tmp1.<a class="code" href="classTreeElement.html#a5">clear</a>();
00055                 }
00056 
00057                 <span class="keywordflow">if</span> (i+1&lt;m_nScenePatches) {
00058                         <a class="code" href="classSelectionTree.html#a5">fillElement</a>(i+1, tmp2);
00059                 } <span class="keywordflow">else</span> {
00060                         tmp2.<a class="code" href="classTreeElement.html#a5">clear</a>();
00061                 }
00062                 <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>[k++] = tmp1+tmp2;
00063         }
00064 
00065         <span class="comment">// the leaves are done, build the tree!</span>
00066         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l=log2-2; l&gt;=0; l--) {
00067                 <span class="keywordtype">long</span> start=(1&lt;&lt;l)-1;
00068                 <span class="keywordtype">long</span> end=(1&lt;&lt;(l+1))-1;
00069 
00070                 <span class="keywordflow">for</span> (<span class="keywordtype">long</span> m=start; m&lt;end; m++) {
00071                         <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>[m] = <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>[(m&lt;&lt;1)+1] + m_TreeElements[(m&lt;&lt;1)+2];
00072                 }
00073         }
00074 }
00075 
00076 
<a name="l00077"></a><a class="code" href="classSelectionTree.html#a3">00077</a> <span class="keywordtype">void</span> <a class="code" href="classSelectionTree.html#a3">SelectionTree::Update</a>(<span class="keywordtype">long</span> index)
00078 {
00079         <span class="keywordtype">long</span> l=(<a class="code" href="classSelectionTree.html#n1">m_nElements</a>+index-1)&gt;&gt;1;
00080         <span class="keywordtype">long</span> index2 = index + ( index%2==0 ? 1 : -1 );
00081 
00082         <a class="code" href="classTreeElement.html">TreeElement</a> tmp1, tmp2;
00083         <span class="keywordflow">if</span> (index&lt;<a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a>) {
00084                 <a class="code" href="classSelectionTree.html#a5">fillElement</a>(index, tmp1);
00085         } <span class="keywordflow">else</span> {
00086                 tmp1.<a class="code" href="classTreeElement.html#a5">clear</a>();
00087         }
00088 
00089         <span class="keywordflow">if</span> (index2&lt;<a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a>) {
00090                 <a class="code" href="classSelectionTree.html#a5">fillElement</a>(index2, tmp2);
00091         } <span class="keywordflow">else</span> {
00092                 tmp2.<a class="code" href="classTreeElement.html#a5">clear</a>();
00093         }
00094 
00095         <span class="comment">// calculate the leaf</span>
00096         <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>[l] = tmp1+tmp2;
00097 
00098         <span class="comment">// propagate the value up to the root</span>
00099         <span class="keywordflow">for</span> (l=(l-1)&gt;&gt;1; l&gt;=0; l=(l-1)&gt;&gt;1) {
00100                 <a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>[l]=<a class="code" href="classSelectionTree.html#n0">m_TreeElements</a>[(l&lt;&lt;1)+1]+m_TreeElements[(l&lt;&lt;1)+2];
00101         }
00102 }
00103 
00104 
<a name="l00105"></a><a class="code" href="classSelectionTree.html#a4">00105</a> <span class="keywordtype">long</span> <a class="code" href="classSelectionTree.html#a4">SelectionTree::FindDistrib</a>(<span class="keywordtype">float</span> p, <span class="keywordtype">long</span> nIteration)
00106 {
00107         p*=<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(nIteration);
00108 
00109         <span class="comment">// indx points to the left leaf</span>
00110         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> indx = 1; indx&lt;<a class="code" href="classSelectionTree.html#n1">m_nElements</a>; indx = (indx&lt;&lt;1)+1) {
00111                 <span class="keyword">const</span> <span class="keywordtype">float</span> left=<a class="code" href="classSelectionTree.html#a6">getValue</a>(m_TreeElements[indx], nIteration);
00112                 <span class="keywordflow">if</span> (p&gt;left) {
00113                         <span class="comment">// go right</span>
00114                         indx++;
00115                         p-=left;
00116                 }
00117         }
00118 
00119         <span class="keywordtype">long</span> l=indx-m_nElements;
00120         <span class="keywordflow">if</span> (l&gt;=<a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a>) 
00121                 <span class="keywordflow">return</span> <a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a>-1;
00122 
00123         <span class="comment">//End of the tree; check the 2 leaves</span>
00124         <span class="comment">//i.e. check the left. If it is too small, pick the right one</span>
00125         <span class="keywordflow">if</span> (p &gt; <a class="code" href="classSelectionTree.html#a7">getValue2</a>(l, nIteration)) l++;
00126         <span class="keywordflow">if</span> (l&gt;=<a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a>) 
00127                 <span class="keywordflow">return</span> <a class="code" href="classSelectionTree.html#n2">m_nScenePatches</a>-1;
00128         <span class="keywordflow">else</span> <span class="keywordflow">return</span> l;
00129 }
00130 
00131 <span class="comment">//-----------------------------------------</span>
00132 <span class="comment">//-----------  PowerTree specific method --</span>
00133 <span class="comment">//-----------------------------------------</span>
<a name="l00134"></a><a class="code" href="classPowerTree.html#a0">00134</a> <span class="keywordtype">void</span> <a class="code" href="classPowerTree.html#a0">PowerTree::fillElement</a>(<span class="keywordtype">long</span> patchIndex, <a class="code" href="classTreeElement.html">TreeElement</a>&amp; t)
00135 {
00136         t.<a class="code" href="classTreeElement.html#m1">reflected</a>=<a class="code" href="globals_8hpp.html#a2">M_PI</a>*<a class="code" href="classSelectionTree.html#n3">m_pScenePatches</a>[patchIndex].<a class="code" href="classTriangle.html#m8">area</a>*m_pScenePatches[patchIndex].Ld.Average();
00137         t.<a class="code" href="classTreeElement.html#m1">reflected</a>+=m_pScenePatches[patchIndex].area*m_pScenePatches[patchIndex].C_I;
00138         
00139         <span class="keywordflow">if</span> (m_pScenePatches[patchIndex].m_pMaterial-&gt;m_edf) {
00140                 t.<a class="code" href="classTreeElement.html#m0">emitted</a>=m_pScenePatches[patchIndex].m_pMaterial-&gt;m_edf-&gt;GetPowerOfArea(m_pScenePatches[patchIndex].area).Average();
00141         }
00142         <span class="keywordflow">else</span> {
00143                 t.<a class="code" href="classTreeElement.html#m0">emitted</a>=0.0f;
00144         }
00145 }
00146 
00147 <span class="comment">//------------------------------------------------------</span>
00148 <span class="comment">//-----------  ImportanceTree specific method ----------</span>
00149 <span class="comment">//------------------------------------------------------</span>
<a name="l00150"></a><a class="code" href="classImportanceTree.html#a0">00150</a> <span class="keywordtype">void</span> <a class="code" href="classImportanceTree.html#a0">ImportanceTree::fillElement</a>(<span class="keywordtype">long</span> patchIndex, <a class="code" href="classTreeElement.html">TreeElement</a>&amp; t) 
00151 { 
00152         <span class="keywordflow">if</span> (<a class="code" href="classSelectionTree.html#n3">m_pScenePatches</a>[patchIndex].<a class="code" href="classPatch.html#m0">visible</a>) {
00153                 <span class="comment">// t.emitted = average albedo</span>
00154                 t.<a class="code" href="classTreeElement.html#m0">emitted</a> = <a class="code" href="classSelectionTree.html#n3">m_pScenePatches</a>[patchIndex].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a13">GetReflectanceLum</a>(); 
00155         } <span class="keywordflow">else</span> {
00156                 t.<a class="code" href="classTreeElement.html#m0">emitted</a> = 0.0f;
00157         }
00158 
00159         t.<a class="code" href="classTreeElement.html#m1">reflected</a> = (<a class="code" href="globals_8hpp.html#a2">M_PI</a>*<a class="code" href="classSelectionTree.html#n3">m_pScenePatches</a>[patchIndex].<a class="code" href="classPatch.html#m6">Rd</a> + m_pScenePatches[patchIndex].C_W); 
00160 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Feb 18 18:30:34 2003 for Stochastic Iteration for Non-diffuse Global Illumination by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
