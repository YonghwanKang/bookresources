<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KDTree.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>KDTree.hpp</h1><a href="KDTree_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// Graphics Programming Methods</span>
00002 <span class="comment">// An Effective kd-tree Implementation</span>
00003 <span class="comment">// László Szécsi</span>
00004 <span class="comment">// 2003.</span>
00005 
00006 <span class="comment">// declaration of kd-tree members</span>
00007 
00008 <span class="preprocessor">#pragma once</span>
00009 <span class="preprocessor"></span>
00010 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
00011 <span class="preprocessor">#include "<a class="code" href="Heap_8hpp.html">Heap.hpp</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="World_8hpp.html">World.hpp</a>"</span>
00013 
<a name="l00014"></a><a class="code" href="KDTree_8hpp.html#a0">00014</a> <span class="preprocessor">#define KDTREE_CACHE_LINE_BYTES                                 128</span>
00015 <span class="preprocessor"></span><span class="comment"></span>
00016 <span class="comment">/*! This class implements a kd-tree. Splitting, termination and cutting of empty space is</span>
00017 <span class="comment">based on cost estimation. Memory representation uses cache-line sized sub-trees and</span>
00018 <span class="comment">mapping of an unbalanced tree into an array. */</span>
<a name="l00019"></a><a class="code" href="classKDTree.html">00019</a> <span class="keyword">class </span><a class="code" href="classKDTree.html">KDTree</a> {<span class="comment"></span>
00020 <span class="comment">        //! number of cache line sized memory segments used</span>
<a name="l00021"></a><a class="code" href="classKDTree.html#o0">00021</a> <span class="comment"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classKDTree.html#o0">nCacheLines</a>;
00022 <span class="comment"></span>
00023 <span class="comment">        //! number of nodes per cache line</span>
<a name="l00024"></a><a class="code" href="classKDTree.html#o1">00024</a> <span class="comment"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classKDTree.html#o1">maxNCacheLines</a>;            
00025 <span class="comment"></span>
00026 <span class="comment">        //! number of nodes per cache line</span>
<a name="l00027"></a><a class="code" href="classKDTree.html#o2">00027</a> <span class="comment"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classKDTree.html#o2">nCacheLineNodes</a>;   
00028 <span class="comment"></span>
00029 <span class="comment">        //! bytes per cache line</span>
<a name="l00030"></a><a class="code" href="classKDTree.html#o3">00030</a> <span class="comment"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classKDTree.html#o3">nCacheLineBytes</a>;   
00031 <span class="comment"></span>
00032 <span class="comment">        //! bounding box containing all objects</span>
<a name="l00033"></a><a class="code" href="classKDTree.html#o4">00033</a> <span class="comment"></span>        <a class="code" href="classBoundingBox.html">BoundingBox</a>     <a class="code" href="classKDTree.html#o4">boundingBox</a>;            
00034 <span class="comment"></span>
00035 <span class="comment">        //! memory allocated for nodes</span>
<a name="l00036"></a><a class="code" href="classKDTree.html#o5">00036</a> <span class="comment"></span>        <span class="keywordtype">float</span>* <a class="code" href="classKDTree.html#o5">poolNodeTable</a>;                   
00037 <span class="comment"></span>
00038 <span class="comment">        //! array aligned on cache lines</span>
<a name="l00039"></a><a class="code" href="classKDTree.html#o6">00039</a> <span class="comment"></span>        <span class="keywordtype">float</span>* <a class="code" href="classKDTree.html#o6">nodeTable</a>;                               
00040 <span class="comment"></span>
00041 <span class="comment">        //! number of objects</span>
<a name="l00042"></a><a class="code" href="classKDTree.html#o7">00042</a> <span class="comment"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            <a class="code" href="classKDTree.html#o7">nObjects</a>;       
00043 <span class="comment"></span>
00044 <span class="comment">        //! array objects</span>
<a name="l00045"></a><a class="code" href="classKDTree.html#o8">00045</a> <span class="comment"></span>        <a class="code" href="classIntersectable.html">Intersectable</a>**         <a class="code" href="classKDTree.html#o8">objects</a>;        
00046 <span class="comment"></span>
00047 <span class="comment">        //! minimum heap to store indices of free nodes during the build</span>
<a name="l00048"></a><a class="code" href="classKDTree.html#o9">00048</a> <span class="comment"></span>        <a class="code" href="classHeap.html">Heap&lt;unsigned int&gt;</a>* <a class="code" href="classKDTree.html#o9">freeNodes</a>;
00049 <span class="comment"></span>
00050 <span class="comment">        //! stack to implement the recursive traversal algorithm</span>
<a name="l00051"></a><a class="code" href="structKDTree_1_1TraverseStack.html">00051</a> <span class="comment"></span>        <span class="keyword">struct </span><a class="code" href="structKDTree_1_1TraverseStack.html">TraverseStack</a>{
<a name="l00052"></a><a class="code" href="structKDTree_1_1TraverseStack.html#m0">00052</a>                 <span class="keywordtype">float</span> <a class="code" href="structKDTree_1_1TraverseStack.html#m0">rayMin</a>;                           <span class="comment">// minimum distance from origin</span>
<a name="l00053"></a><a class="code" href="structKDTree_1_1TraverseStack.html#m1">00053</a>                 <span class="keywordtype">float</span> <a class="code" href="structKDTree_1_1TraverseStack.html#m1">rayMax</a>;                           <span class="comment">// maximum distance from origin</span>
<a name="l00054"></a><a class="code" href="structKDTree_1_1TraverseStack.html#m2">00054</a>                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structKDTree_1_1TraverseStack.html#m2">tNode</a>;                     <span class="comment">// node index of kd-tree node to be traced</span>
00055         } *<a class="code" href="classKDTree.html#o10">traverseStack</a>;
<a name="l00056"></a><a class="code" href="classKDTree.html#o11">00056</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classKDTree.html#o11">depth</a>;
<a name="l00057"></a><a class="code" href="classKDTree.html#o12">00057</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classKDTree.html#o12">currentDepth</a>;
00058 
<a name="l00059"></a><a class="code" href="classKDTree.html#o13">00059</a>         <span class="keywordtype">float</span> <a class="code" href="classKDTree.html#o13">epsilon</a>;
00060 <span class="comment"></span>
00061 <span class="comment">        //! traces the tree defined by root node index 'nodeID',</span>
00062 <span class="comment">        //! and frees the memory occupied by the object lists</span>
00063 <span class="comment"></span>        <span class="keywordtype">void</span> <a class="code" href="classKDTree.html#c0">deleteLeaves</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nodeID);
00064 <span class="comment"></span>
00065 <span class="comment">        //! recursive algorithm to build the tree</span>
00066 <span class="comment"></span><span class="comment">        /*!</span>
00067 <span class="comment">        @param nodeID                   node index of kd-tree node to be created</span>
00068 <span class="comment">        @param boundsArray              array of duplicated object indices, first bit tells mimima and maxima apart</span>
00069 <span class="comment">        @param nObjects                 number of objects (boundsArray's size is 2*nObjects)</span>
00070 <span class="comment">        @param limits                   kd-tree node volume</span>
00071 <span class="comment">        @param axisNmask                bits 5,4,3 indicate z,y,x failed cut attempts, bits 1,0 identify cut axis to be used</span>
00072 <span class="comment">        */</span>
00073         <span class="keywordtype">void</span> <a class="code" href="classKDTree.html#c1">build</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nodeID, 
00074                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* boundsArray,
00075                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nObjects,          
00076                 <a class="code" href="classBoundingBox.html">BoundingBox</a>&amp; limits,            
00077                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> axisNmask);
00078 <span class="comment"></span>
00079 <span class="comment">        //! qSort an array segment of object extremes</span>
00080 <span class="comment"></span>        <span class="keywordtype">void</span> <a class="code" href="classKDTree.html#c2">quickSort</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* lo0, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* hi0, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> axis);
00081 <span class="comment"></span>
00082 <span class="comment">        //! compare two object extrema according to the coordinate specified</span>
00083 <span class="comment"></span>        <span class="keywordtype">bool</span> <span class="keyword">inline</span> <a class="code" href="classKDTree.html#c3">compare</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> aIndex, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bIndex, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> axis);
00084 <span class="comment"></span>
00085 <span class="comment">        //! return the value of the object extreme referenced</span>
00086 <span class="comment"></span>        <span class="keywordtype">float</span> <span class="keyword">inline</span> <a class="code" href="classKDTree.html#c4">getBoundValue</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> * extremeIndex, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> axis);
00087 <span class="comment"></span>
00088 <span class="comment">        //! binary search: finds the position of value 'loc' in a sorted array partition</span>
00089 <span class="comment"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* <a class="code" href="classKDTree.html#c5">findBound</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* extremeArrayStart, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nBounds, <span class="keywordtype">float</span> loc, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> axis);
00090         <span class="comment"></span>
00091 <span class="comment">        //! tell if a node is a leaf</span>
00092 <span class="comment"></span>        <span class="keywordtype">bool</span> <span class="keyword">inline</span> <a class="code" href="classKDTree.html#c6">isLeaf</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> xnode);
00093 <span class="comment"></span>
00094 <span class="comment">        //! retrieve the node indices corresponding to the children of the specified node</span>
00095 <span class="comment">        //! return false if the node is a leaf</span>
00096 <span class="comment"></span>        <span class="keywordtype">bool</span> <span class="keyword">inline</span> <a class="code" href="classKDTree.html#c7">followChildren</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; parent, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;leftChild, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;rightChild);
00097 <span class="comment"></span>
00098 <span class="comment">        //! retrieve would-have-been child nodes of a leaf node, if they are not in a last row</span>
00099 <span class="comment"></span>        <span class="keywordtype">bool</span> <span class="keyword">inline</span> <a class="code" href="classKDTree.html#c8">getFreeNodes</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> parent, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; leftFree, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; rightFree);
00100 <span class="comment"></span>
00101 <span class="comment">        //! accumulate object extrema</span>
<a name="l00102"></a><a class="code" href="classKDTree.html#c9">00102</a> <span class="comment"></span>        <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classKDTree.html#c9">createBoundingBox</a> (<a class="code" href="classIntersectable.html">Intersectable</a>** iObjects, <span class="keywordtype">int</span> nObjects) 
00103         {
00104                 <span class="keywordflow">if</span>(!nObjects)
00105                         <span class="keywordflow">return</span>;
00106                 boundingBox.<a class="code" href="classBoundingBox.html#m0">minPoint</a> = iObjects [0]-&gt;<a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m0">minPoint</a>;
00107                 boundingBox.<a class="code" href="classBoundingBox.html#m1">maxPoint</a> = iObjects [0]-&gt;<a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m1">maxPoint</a>;
00108                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;nObjects; i++) {
00109                         <span class="comment">// check accumulate operators of Vector class</span>
00110                         boundingBox.<a class="code" href="classBoundingBox.html#m0">minPoint</a> &lt;= iObjects [i]-&gt;<a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m0">minPoint</a>;
00111                         boundingBox.<a class="code" href="classBoundingBox.html#m1">maxPoint</a> &gt;= iObjects [i]-&gt;<a class="code" href="classIntersectable.html#m1">bbox</a>.<a class="code" href="classBoundingBox.html#m1">maxPoint</a>;
00112                 }
00113         }
00114 
00115         <span class="comment">/* If the node referenced by oNode is on the last level of a cache-line sized sub-tree,</span>
00116 <span class="comment">        a pointer to a free node is placed, and the index of this free</span>
00117 <span class="comment">        node is returned. Else, originalNode is returned. */</span>
00118         <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classKDTree.html#c10">makePointer</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> originalNode);
00119 
00120 <span class="keyword">public</span>:
00121         <a class="code" href="classKDTree.html#a0">KDTree</a> (<a class="code" href="classIntersectable.html">Intersectable</a>** objects, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nObjects);
<a name="l00122"></a><a class="code" href="classKDTree.html#a1">00122</a>         <a class="code" href="classKDTree.html#a1">~KDTree</a> () {
00123                 <a class="code" href="classKDTree.html#c0">deleteLeaves</a>(0);
00124                 <span class="keyword">delete</span> <a class="code" href="classKDTree.html#o10">traverseStack</a>;
00125                 free(poolNodeTable);
00126         }
00127 
00128         <span class="keywordtype">bool</span> <a class="code" href="classKDTree.html#a2">traverse</a> (<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a>&amp; ray, <a class="code" href="classHitRec.html">HitRec</a>&amp; hitRec, <span class="keywordtype">float</span> minT, <span class="keywordtype">float</span> maxT);
00129         <a class="code" href="classBoundingBox.html">BoundingBox</a>&amp; <a class="code" href="classKDTree.html#a3">getBoundingBox</a>();
00130 };
</pre></div><hr><address style="align: right;"><small>Generated on Tue Feb 18 18:30:34 2003 for Stochastic Iteration for Non-diffuse Global Illumination by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
