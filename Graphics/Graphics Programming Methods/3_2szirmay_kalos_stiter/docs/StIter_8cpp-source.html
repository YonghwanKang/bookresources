<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>StIter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>StIter.cpp</h1><a href="StIter_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00002 <span class="preprocessor">#include &lt;gl/gl.h&gt;</span>
00003 <span class="preprocessor">#include &lt;gl/glu.h&gt;</span>
00004 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00005 
00006 <span class="preprocessor">#include "stiter.hpp"</span>
00007 <span class="preprocessor">#include "<a class="code" href="SelectionTree_8hpp.html">SelectionTree.hpp</a>"</span>
00008 
<a name="l00009"></a><a class="code" href="classStIter.html#a0">00009</a> <a class="code" href="classStIter.html#a0">StIter::StIter</a>(<a class="code" href="classScene.html">Scene</a>* scene, <span class="keywordtype">long</span> iteration, <span class="keywordtype">float</span> power, <span class="keywordtype">float</span> importance)
00010 : m_pScene(scene), m_maxIteration(iteration)
00011 {
00012         printf(<span class="stringliteral">"Start rendering...\n"</span>
00013                 <span class="stringliteral">"# of iteration=%d\n"</span>
00014                 <span class="stringliteral">"samples per light=%d\n"</span>
00015                 <span class="stringliteral">"power=%d%% importance=%d%% mixed=%d%%\n\n"</span>, 
00016                 m_maxIteration, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z11_2">m_samplesPerLight</a>, 
00017                 (<span class="keywordtype">long</span>)(power*100), (<span class="keywordtype">long</span>)(importance*100), (<span class="keywordtype">long</span>)((100.5f-(power+importance)*100)) );
00018 
00019         <a class="code" href="classStIter.html#o9">time_start</a> = clock ();  
00020 
00021         <a class="code" href="classStIter.html#o1">m_screenBuffer</a>.<a class="code" href="classScreenBuffer.html#a3">Initialize</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>);
00022 
00023         <a class="code" href="classStIter.html#o6">m_probPatchSelection_Power</a>      = power;
00024         <a class="code" href="classStIter.html#o7">m_probPatchSelection_Importance</a> = importance;
00025         <a class="code" href="classStIter.html#o8">m_probPatchSelection_Mix</a> = (1.0f - <a class="code" href="classStIter.html#o7">m_probPatchSelection_Importance</a> - <a class="code" href="classStIter.html#o6">m_probPatchSelection_Power</a>);
00026 
00027         <a class="code" href="classStIter.html#o13">m_VisibilityInfo</a>=NULL;
00028         <a class="code" href="classStIter.html#o12">m_vertexColors</a> = <span class="keyword">new</span> <a class="code" href="classVector.html">Color</a>[<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_2">nSceneVertices</a>];
00029 
00030         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i=0; i&lt;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>; i++) {
00031                 <a class="code" href="classPatch.html">Patch</a>* p=&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i];
00032                 p-&gt;<a class="code" href="classPatch.html#a0">Reset</a>();
00033 
00034                 p-&gt;<a class="code" href="classPatch.html#m10">m_VisDir</a> = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m0">eyep</a> - p-&gt;<a class="code" href="classTriangle.html#m4">midPoint</a>;
00035                 p-&gt;<a class="code" href="classPatch.html#m10">m_VisDir</a>.<a class="code" href="classVector.html#a20">Normalize</a>();
00036                 p-&gt;<a class="code" href="classPatch.html#m9">dirW</a> = p-&gt;<a class="code" href="classPatch.html#m11">m_EyePatchDir</a> = -p-&gt;<a class="code" href="classPatch.html#m10">m_VisDir</a>;
00037         }
00038 }
00039 
<a name="l00040"></a><a class="code" href="classStIter.html#a1">00040</a> <a class="code" href="classStIter.html#a1">StIter::~StIter</a>()
00041 {
00042         <span class="keyword">delete</span> <a class="code" href="classStIter.html#o2">m_pImportanceTree</a>;
00043         <span class="keyword">delete</span> <a class="code" href="classStIter.html#o3">m_pPowerTree</a>;
00044         <span class="keyword">delete</span>[] <a class="code" href="classStIter.html#o12">m_vertexColors</a>;
00045         <span class="keyword">delete</span>[] <a class="code" href="classStIter.html#o13">m_VisibilityInfo</a>;
00046 }
00047 
00048 
<a name="l00049"></a><a class="code" href="classStIter.html#c1">00049</a> <span class="keywordtype">bool</span> <a class="code" href="classStIter.html#c1">StIter::SetWindowPixelFormat</a>(HDC hDC, DWORD dwFlags, BYTE colorBits) {
00050 
00051         PIXELFORMATDESCRIPTOR pixelDesc;
00052 
00053         pixelDesc.nSize         = <span class="keyword">sizeof</span>(PIXELFORMATDESCRIPTOR);
00054         pixelDesc.nVersion      = 1;
00055         pixelDesc.dwFlags                       = dwFlags;
00056         pixelDesc.iPixelType            = PFD_TYPE_RGBA;
00057         pixelDesc.cColorBits            = colorBits;
00058         pixelDesc.cRedBits                      = 8;
00059         pixelDesc.cRedShift                     = 16;
00060         pixelDesc.cGreenBits            = 8;
00061         pixelDesc.cGreenShift           = 8;
00062         pixelDesc.cBlueBits                     = 8;
00063         pixelDesc.cBlueShift            = 0;
00064         pixelDesc.cAlphaBits            = 0;
00065         pixelDesc.cAlphaShift           = 0;
00066         pixelDesc.cAccumBits            = 64;   
00067         pixelDesc.cAccumRedBits         = 16;
00068         pixelDesc.cAccumGreenBits       = 16;
00069         pixelDesc.cAccumBlueBits        = 16;
00070         pixelDesc.cAccumAlphaBits       = 0;
00071         pixelDesc.cDepthBits            = 32;
00072         pixelDesc.cStencilBits          = 8;
00073         pixelDesc.cAuxBuffers           = 0;
00074         pixelDesc.iLayerType            = PFD_MAIN_PLANE;
00075         pixelDesc.bReserved                     = 0;
00076         pixelDesc.dwLayerMask           = 0;
00077         pixelDesc.dwVisibleMask         = 0;
00078         pixelDesc.dwDamageMask          = 0;
00079 
00080         <span class="keywordtype">int</span> openGLPixelIndex = ::ChoosePixelFormat (hDC, &amp;pixelDesc);
00081         <span class="keywordflow">if</span> (openGLPixelIndex==0) { <span class="comment">// Let's choose a default index. </span>
00082                 openGLPixelIndex = 1;    
00083                 <span class="keywordflow">if</span> (DescribePixelFormat (hDC, openGLPixelIndex, <span class="keyword">sizeof</span>(PIXELFORMATDESCRIPTOR), &amp;pixelDesc) == 0)
00084                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00085         }
00086         
00087         <span class="keywordflow">if</span> (SetPixelFormat (hDC, openGLPixelIndex, &amp;pixelDesc) == <span class="keyword">false</span>)
00088                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00089         
00090         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00091 }
00092 
<a name="l00093"></a><a class="code" href="StIter_8cpp.html#a0">00093</a> <span class="preprocessor">#define RED(x)                  ((x) &amp; 0xff);</span>
<a name="l00094"></a><a class="code" href="StIter_8cpp.html#a1">00094</a> <span class="preprocessor"></span><span class="preprocessor">#define GREEN(x)                (((x) &gt;&gt; 8) &amp; 0xff) </span>
<a name="l00095"></a><a class="code" href="StIter_8cpp.html#a2">00095</a> <span class="preprocessor"></span><span class="preprocessor">#define BLUE(x)                 (((x) &gt;&gt; 16) &amp; 0xff)</span>
<a name="l00096"></a><a class="code" href="StIter_8cpp.html#a3">00096</a> <span class="preprocessor"></span><span class="preprocessor">#define INT(r, g, b)    (((r) + ((g) &lt;&lt; 8) + ((b) &lt;&lt; 16)))</span>
00097 <span class="preprocessor"></span><span class="comment">/*! Determine visibility by rendering the scene using unique color for each patch.</span>
00098 <span class="comment">This clearly shows in which pixel which patch can be seen.*/</span>
<a name="l00099"></a><a class="code" href="classStIter.html#c0">00099</a> <span class="keywordtype">void</span> <a class="code" href="classStIter.html#c0">StIter::DetermineVisibility</a>()
00100 {
00101         printf(<span class="stringliteral">"Determining visibility...\n"</span>);
00102         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* Image= <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[3 * (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a> + 1) * (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a> + 1)];
00103 
00104         BYTE* m_pBitmapBits;
00105 
00106 <span class="comment"></span>
00107 <span class="comment">        //! memory device context</span>
00108 <span class="comment"></span>        HDC     DC = ::CreateCompatibleDC(NULL);
00109 
00110         BITMAPINFO                              bmi;
00111         memset (&amp;bmi, 0, <span class="keyword">sizeof</span>(BITMAPINFO));
00112         bmi.bmiHeader.biSize                    = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
00113         bmi.bmiHeader.biWidth                   = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>;
00114         bmi.bmiHeader.biHeight                  = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a>;
00115         bmi.bmiHeader.biPlanes                  = 1;
00116         bmi.bmiHeader.biBitCount                = 24;
00117         bmi.bmiHeader.biCompression             = BI_RGB;
00118         bmi.bmiHeader.biSizeImage               = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a> * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a> * 3;
00119 <span class="comment"></span>
00120 <span class="comment">        //! the DIB format bitmap</span>
00121 <span class="comment"></span>        HBITMAP hDib = ::CreateDIBSection (DC, &amp;bmi, DIB_RGB_COLORS, (<span class="keywordtype">void</span>**)&amp;m_pBitmapBits, NULL, (DWORD)0);
00122         SelectObject (DC, hDib);
00123         
00124         <span class="keywordtype">bool</span> res=<a class="code" href="classStIter.html#c1">SetWindowPixelFormat</a> (DC, PFD_DRAW_TO_BITMAP | PFD_SUPPORT_OPENGL | PFD_STEREO_DONTCARE, 24);<span class="comment"></span>
00125 <span class="comment">        //! memory rendering context</span>
00126 <span class="comment"></span>        HGLRC RC = wglCreateContext (DC);
00127 
00128         <span class="keywordflow">if</span> (RC==NULL) 
00129                 <span class="keywordflow">return</span>;
00130 
00131         <span class="keywordflow">if</span> (wglMakeCurrent (DC, RC)==FALSE) <span class="keywordflow">return</span>;
00132 
00133         <span class="comment">// Default mode</span>
00134         glEnable (GL_NORMALIZE);
00135         
00136         <span class="comment">// Lights, material properties</span>
00137         glClearColor (0, 0, 0, 0);
00138         glClearDepth (1.0);
00139         
00140         glEnable (GL_CULL_FACE);
00141         glPolygonMode (GL_FRONT, GL_FILL);              
00142 
00143         glShadeModel (GL_FLAT);
00144     glEnable (GL_DEPTH_TEST);   <span class="comment">// z-buffer</span>
00145     glDisable (GL_DITHER);              <span class="comment">// no dither</span>
00146         
00147         glDisable (GL_LIGHTING);
00148         glDrawBuffer (GL_FRONT);
00149 
00150         GLsizei width = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>;
00151         GLsizei height = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a>;
00152         GLfloat aspect;
00153         <span class="keywordflow">if</span> (height == 0)
00154                 aspect = (GLfloat) width;
00155         <span class="keywordflow">else</span>
00156                 aspect = (GLfloat) width / (GLfloat) height;
00157 
00158         glViewport (0, 0, width, height);
00159         glMatrixMode (GL_PROJECTION);
00160         glLoadIdentity ();
00161         gluPerspective (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m6">vfov</a> * 2.0, aspect, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m7">nearClip</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m8">farClip</a>);
00162 
00163         glMatrixMode (GL_MODELVIEW);
00164         glLoadIdentity ();
00165         glClear (GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
00166         gluLookAt (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m0">eyep</a>.<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m0">eyep</a>.<a class="code" href="classVector.html#m2">y</a> ,<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m0">eyep</a>.<a class="code" href="classVector.html#m3">z</a>,
00167                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m1">lookp</a>.<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m1">lookp</a>.<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m1">lookp</a>.<a class="code" href="classVector.html#m3">z</a>,
00168                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m2">updir</a>.<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m2">updir</a>.<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m2">updir</a>.<a class="code" href="classVector.html#m3">z</a>);
00169 
00170         <span class="comment">// set up scene</span>
00171         glPushMatrix ();
00172 
00173         glBegin (GL_TRIANGLES);
00174         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k = 0; k &lt; <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>; k++) {
00175                 <span class="comment">// glClearColor is set to black (0.0f, 0.0f, 0.0f)</span>
00176                 <span class="comment">// therefore the first availabe color index will have an offset of 1 </span>
00177                 GLubyte r = (GLubyte)<a class="code" href="StIter_8cpp.html#a0">RED</a> (k+1);
00178                 GLubyte g = (GLubyte)<a class="code" href="StIter_8cpp.html#a1">GREEN</a> (k+1); 
00179                 GLubyte b = (GLubyte)<a class="code" href="StIter_8cpp.html#a2">BLUE</a> (k+1); 
00180 
00181                 glColor3ub (r, g, b);
00182 
00183                 glVertex3d (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m0">a</a>-&gt;<a class="code" href="classVector.html#m3">z</a>);
00184                 glVertex3d (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m1">b</a>-&gt;<a class="code" href="classVector.html#m3">z</a>);
00185                 glVertex3d (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m1">x</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m2">y</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[k].<a class="code" href="classTriangle.html#m2">c</a>-&gt;<a class="code" href="classVector.html#m3">z</a>);
00186         }
00187         glEnd ();
00188 
00189 
00190         glPopMatrix ();
00191         ::glFlush();
00192 
00193         glPixelStorei(GL_PACK_ALIGNMENT, 1);
00194         glReadPixels (0, 0, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a>, GL_RGB, GL_UNSIGNED_BYTE, &amp;Image[0]);
00195 
00196         <span class="comment">// make the rendering context not current</span>
00197         wglMakeCurrent (NULL, NULL);
00198 
00199         <span class="comment">// delete the rendering context </span>
00200         wglDeleteContext (RC);
00201         DeleteDC (DC);
00202         DeleteObject (hDib);
00203 
00204 
00205         <span class="keywordflow">if</span> (m_VisibilityInfo) <span class="keyword">delete</span> <a class="code" href="classStIter.html#o13">m_VisibilityInfo</a>;
00206         m_VisibilityInfo = <span class="keyword">new</span> <a class="code" href="classHitRec.html">HitRec</a>[<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a>*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>];
00207 
00208         <a class="code" href="classRay.html">Ray</a> ray;
00209         ray.<a class="code" href="classRay.html#m0">origin</a> = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m0">eyep</a>;   
00210         <span class="keywordtype">float</span>&amp;  h = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m14">pixh</a>;
00211         <span class="keywordtype">float</span>&amp;  v = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m15">pixv</a>;
00212 
00213         <span class="comment">// calculate the middle of the pixel</span>
00214         <span class="keywordtype">float</span>   pix_x = (float)(-h * width  / 2.0f + h/2.0f);
00215         <span class="keywordtype">float</span>   pix_y = (float)(-v * height / 2.0f + v/2.0f);
00216 
00217         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> y = 0; y &lt; <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a>; y++ ) {
00218                 <span class="keywordflow">for</span> (<span class="keywordtype">long</span> x = 0; x &lt; <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>; x++) {
00219                         <span class="comment">//OpenGL image is upside-down</span>
00220                         <span class="keywordtype">long</span> i=3*((<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a>-y-1)*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>+x);
00221 
00222                         <span class="comment">// don't forget about the offset in patch-color indexing!</span>
00223                         <span class="keywordtype">long</span> j=<a class="code" href="StIter_8cpp.html#a3">INT</a>(Image[i], Image[i+1], Image[i+2])-1;
00224 
00225                         <span class="keywordflow">if</span> (j&gt;=0 &amp;&amp; j&lt;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a> ) {
00226                                 <span class="keywordtype">long</span> pixelID = y*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>+x;
00227 
00228                                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m0">visible</a>=<span class="keyword">true</span>;
00229                                 m_VisibilityInfo[pixelID].object = &amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j];
00230 
00231                                 <span class="comment">//Calculate m_VisibilityInfo[pixelID].depth, m_VisibilityInfo[pixelID].point</span>
00232                                 ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#a26">SetLinearCombination</a> (<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m13">Z</a>, pix_x+x*h, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m11">X</a>, pix_y+y*v, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m12">Y</a>);
00233                                 ray.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#a20">Normalize</a>();
00234                                 ray.<a class="code" href="classRay.html#m2">id</a> = ++ray.<a class="code" href="classRay.html#p0">maxRayID</a>;
00235 
00236                                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#a1">CalculateIntersection</a>(ray, m_VisibilityInfo[pixelID]);
00237 
00238                                 <span class="comment">//Assign screen pixels to their patch</span>
00239                                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m1">nScreenPixel</a>++;
00240                         }
00241                         <span class="keywordflow">else</span> {
00242                                 m_VisibilityInfo[y*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>+x].object = NULL;
00243                         }
00244                 }
00245         }
00246 
00247         <span class="keyword">delete</span> Image;
00248 }
00249 
<a name="l00250"></a><a class="code" href="classStIter.html#c2">00250</a> <span class="keywordtype">void</span> <a class="code" href="classStIter.html#c2">StIter::CalculateDirectLight</a>()
00251 {
00252         printf(<span class="stringliteral">"Calculating direct illumination...\n"</span>);
00253         <a class="code" href="classRay.html">Ray</a> ray;
00254         ray.<a class="code" href="classRay.html#m0">origin</a> = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m0">eyep</a>;   
00255 
00256         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m10">vres</a>; y++) {
00257                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>; x++) {
00258                         <a class="code" href="classVector.html">Color</a> thisRgb = Color::BLACK;
00259                         <span class="keywordtype">long</span> pixelID=y*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>.<a class="code" href="classCamera.html#m9">hres</a>+x;
00260                         <a class="code" href="classPatch.html">Patch</a>* patch = (<a class="code" href="classPatch.html">Patch</a>*)<a class="code" href="classStIter.html#o13">m_VisibilityInfo</a>[pixelID].<a class="code" href="classHitRec.html#m2">object</a>;
00261 
00262                         <span class="keywordflow">if</span> (patch) {
00263                                 <span class="keyword">const</span> <a class="code" href="classMaterial.html">Material</a>* pMaterial = patch-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>;
00264 
00265                                 <span class="comment">// emission color of the visible surface point</span>
00266                                 <span class="keywordflow">if</span> (pMaterial-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a> != NULL)
00267                                         thisRgb = pMaterial-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a>-&gt;<a class="code" href="classCPhongEdf.html#a3">GetEmissionRad</a>();
00268 
00269                                 ray.<a class="code" href="classRay.html#m1">dir</a>=(<a class="code" href="classStIter.html#o13">m_VisibilityInfo</a>[pixelID].<a class="code" href="classHitRec.html#m0">point</a>-ray.<a class="code" href="classRay.html#m0">origin</a>)/<a class="code" href="classStIter.html#o13">m_VisibilityInfo</a>[pixelID].<a class="code" href="classHitRec.html#m1">depth</a>;
00270                                 thisRgb+=<a class="code" href="classStIter.html#c3">SampleLightSources</a> (m_VisibilityInfo[pixelID], ray);
00271                         } <span class="keywordflow">else</span> {
00272                                 <span class="comment">// NOP - No patch is visible in the pixel</span>
00273                         }
00274                         <a class="code" href="classStIter.html#o1">m_screenBuffer</a>.<a class="code" href="classScreenBuffer.html#a5">SetRadiance</a> (x, y, thisRgb);
00275                 }
00276         }
00277 }
00278 
<a name="l00279"></a><a class="code" href="classStIter.html#c3">00279</a> <a class="code" href="classVector.html">Color</a> <a class="code" href="classStIter.html#c3">StIter::SampleLightSources</a>(<span class="keyword">const</span> <a class="code" href="classHitRec.html">HitRec</a>&amp; hitRec, <span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a>&amp; ray)
00280 {
00281         <a class="code" href="classVector.html">Color</a> result=Color::BLACK;
00282         <span class="keywordflow">if</span> (!hitRec.<a class="code" href="classHitRec.html#m2">object</a>) <span class="keywordflow">return</span> result;
00283 
00284         <span class="keywordtype">long</span> visiblePatchID = hitRec.<a class="code" href="classHitRec.html#m2">object</a>-&gt;<a class="code" href="classIntersectable.html#m4">m_index</a>;
00285 
00286         <span class="comment">//diffuse brdf</span>
00287         <a class="code" href="classVector.html">Color</a> kd=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[visiblePatchID].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a8">GetDiffuseBrdf</a>();
00288 
00289         <a class="code" href="classPatch.html">Patch</a>* patch=(<a class="code" href="classPatch.html">Patch</a>*)hitRec.<a class="code" href="classHitRec.html#m2">object</a>;
00290 
00291         <a class="code" href="classRay.html">Ray</a>             rayToLight;
00292         <a class="code" href="classVector.html">Color</a>           L=Color::BLACK;
00293         <a class="code" href="classVector.html">Color</a>           diffuse=Color::BLACK;
00294 
00295         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i = 0; i &lt; <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z11_1">nSceneLights</a>;  i++) {
00296                 L = Color::BLACK;
00297                 diffuse = Color::BLACK;
00298 
00299                 <span class="keywordtype">long</span> nSample = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z11_0">sceneLights</a>[i].<a class="code" href="classLight.html#m1">m_pSamples</a>-&gt;<a class="code" href="classLightSourceSample.html#m1">m_nSamples</a>;
00300 
00301                 <a class="code" href="classPatch.html">Patch</a>* lightPatch=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z11_0">sceneLights</a>[i].<a class="code" href="classLight.html#m0">m_pPatch</a>;
00302                 <span class="keyword">const</span> <a class="code" href="classMaterial.html">Material</a>* pMaterialLight = lightPatch-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>;
00303                 <span class="keyword">const</span> <a class="code" href="classMaterial.html">Material</a>* pMaterialPatch = patch-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>;
00304                 <span class="keyword">const</span> <a class="code" href="classVector.html">Color</a> emission=pMaterialLight-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a>-&gt;<a class="code" href="classCPhongEdf.html#a3">GetEmissionRad</a>();
00305 
00306                 <span class="keywordflow">for</span> (<span class="keywordtype">long</span> j=0; j&lt; nSample; j++) {
00307                         <span class="comment">// a ray from the surface point to the middle point of the lightsource</span>
00308                         rayToLight.<a class="code" href="classRay.html#m2">id</a> = ++<a class="code" href="classRay.html#p0">Ray::maxRayID</a>;
00309                         rayToLight.<a class="code" href="classRay.html#m0">origin</a>       = hitRec.<a class="code" href="classHitRec.html#m0">point</a>;
00310                         rayToLight.<a class="code" href="classRay.html#m1">dir</a> = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z11_0">sceneLights</a>[i].<a class="code" href="classLight.html#m1">m_pSamples</a>-&gt;<a class="code" href="classLightSourceSample.html#m2">samples</a>[j] - hitRec.<a class="code" href="classHitRec.html#m0">point</a>;
00311 
00312                         <span class="comment">// the distance of the surface point and the point of the lightsource</span>
00313                         <span class="keywordtype">float</span>   lightDist = rayToLight.<a class="code" href="classRay.html#m1">dir</a>.<a class="code" href="classVector.html#a18">Norm</a> ();
00314                         rayToLight.<a class="code" href="classRay.html#m1">dir</a> *= (1.0f/lightDist);
00315 
00316                         <span class="comment">// the shading normal at the surface point</span>
00317                         <a class="code" href="classVector.html">Vector</a>  shadingNormal=patch-&gt;<a class="code" href="classTriangle.html#a3">getShadingNormal</a>(hitRec.<a class="code" href="classHitRec.html#m0">point</a>);
00318 
00319                         <span class="keywordtype">float</span>   cost = rayToLight.<a class="code" href="classRay.html#m1">dir</a> * shadingNormal;  <span class="comment">//dot product</span>
00320 
00321                         <span class="comment">// whether or not the front face of the surface is visible from the lightsource</span>
00322                         <span class="keywordflow">if</span> (cost &gt; 0 &amp;&amp; (rayToLight.<a class="code" href="classRay.html#m1">dir</a> * patch-&gt;<a class="code" href="classTriangle.html#m3">normal</a>)&gt;0)  {
00323                                 <a class="code" href="classHitRec.html">HitRec</a>  hitRecToLight;
00324                                 hitRecToLight.<a class="code" href="classHitRec.html#m2">object</a> = NULL;
00325 
00326                                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m2">m_pKDTree</a>-&gt;<a class="code" href="classKDTree.html#a2">traverse</a>(rayToLight, hitRecToLight, 0.0f, lightDist+2*EPSILON);
00327                                 <span class="keywordflow">if</span> (hitRecToLight.<a class="code" href="classHitRec.html#m2">object</a>==NULL) <span class="keywordflow">continue</span>;
00328 
00329                                 <span class="keywordflow">if</span> (hitRecToLight.<a class="code" href="classHitRec.html#m2">object</a>-&gt;<a class="code" href="classIntersectable.html#m4">m_index</a> == visiblePatchID) {
00330                                         printf(<span class="stringliteral">"I've hit myself!\n"</span>);
00331                                 }
00332 
00333                                 <span class="keywordflow">if</span> (hitRecToLight.<a class="code" href="classHitRec.html#m2">object</a>==lightPatch) {
00334                                         <span class="comment">// we should * -1.0 the ray.dir, but do it after make dotProduct</span>
00335                                         <span class="keywordtype">float</span>   cosLightFace = - (rayToLight.<a class="code" href="classRay.html#m1">dir</a> * lightPatch-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00336 
00337                                         <span class="comment">// whether or not the front face of the lightsource is visible from the surface</span>
00338                                         <span class="keywordflow">if</span> (cosLightFace &gt; 0) {
00339                                                 <a class="code" href="classVector.html">Color</a>   brdf=pMaterialPatch-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a0">EvalBrdf</a> (ray.<a class="code" href="classRay.html#m1">dir</a>, rayToLight.<a class="code" href="classRay.html#m1">dir</a>, shadingNormal);
00340 
00341                                                 <span class="comment">// the color from the lightsource reflected to the eye</span>
00342                                                 <a class="code" href="classVector.html">Color</a> I=emission * (cost * cosLightFace * lightPatch-&gt;<a class="code" href="classTriangle.html#m8">area</a> / (lightDist * lightDist));
00343                                                 L+=(I % brdf);  <span class="comment">// blend the values</span>
00344 
00345                                                 <span class="comment">//Initialize diffuse value</span>
00346                                                 diffuse += I;
00347                                         };
00348                                 };
00349                         }       <span class="comment">// if cost</span>
00350                 } <span class="comment">// samples per light</span>
00351                 result += L / (float)nSample;
00352 
00353                 <span class="comment">//Initialize diffuse value</span>
00354                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[visiblePatchID].<a class="code" href="classPatch.html#m2">Ld</a>  += (diffuse % kd) / (float)(nSample * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[visiblePatchID].<a class="code" href="classPatch.html#m1">nScreenPixel</a>);
00355         }       <span class="comment">// for</span>
00356 
00357         <span class="keywordflow">return</span> result;
00358 }
00359 
<a name="l00360"></a><a class="code" href="classStIter.html#a2">00360</a> <span class="keywordtype">void</span> <a class="code" href="classStIter.html#a2">StIter::render</a>()
00361 {
00362         <a class="code" href="classStIter.html#c0">DetermineVisibility</a>();
00363 
00364         <a class="code" href="classStIter.html#o3">m_pPowerTree</a> = <span class="keyword">new</span> <a class="code" href="classPowerTree.html">PowerTree</a>;
00365         <a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a2">Build</a>(<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>);
00366 
00367         <span class="comment">//To build the importance tree, a preceding call to DetermineVisibility() is a must!</span>
00368         <a class="code" href="classStIter.html#o2">m_pImportanceTree</a> = <span class="keyword">new</span> <a class="code" href="classImportanceTree.html">ImportanceTree</a>;
00369         <a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a2">Build</a>(<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>);
00370 
00371         <span class="comment">//Calculate direct illumination</span>
00372         <a class="code" href="classStIter.html#c2">CalculateDirectLight</a>();
00373 
00374 <span class="comment">//enable this if you want to save the direct illumination image</span>
00375 <span class="comment">//into a separate image file</span>
00376 <span class="preprocessor">#ifdef SAVE_DIRECT_ILLUMINATION</span>
00377 <span class="preprocessor"></span>        <a class="code" href="classStIter.html#o1">m_screenBuffer</a>.<a class="code" href="classScreenBuffer.html#a2">Syncronize</a>();
00378         <a class="code" href="classStIter.html#o1">m_screenBuffer</a>.<a class="code" href="classScreenBuffer.html#a8">saveImage</a>(<span class="stringliteral">"direct.tga"</span>);
00379 <span class="preprocessor">#endif</span>
00380 <span class="preprocessor"></span>
00381         printf(<span class="stringliteral">"Calculating indirect illumination...\n"</span>);
00382         <span class="keywordflow">for</span> (<a class="code" href="classStIter.html#o5">m_nIteration</a>=1; <a class="code" href="classStIter.html#o5">m_nIteration</a>&lt;<a class="code" href="classStIter.html#o4">m_maxIteration</a>; <a class="code" href="classStIter.html#o5">m_nIteration</a>++) {
00383                 <a class="code" href="classStIter.html#c4">DoIteration</a>();
00384         }
00385 
00386         <a class="code" href="classStIter.html#o5">m_nIteration</a>--; <span class="comment">//set properly the number of completed iterations</span>
00387 
00388         <a class="code" href="classStIter.html#c5">FinalizeLtoEye</a> ();
00389         <a class="code" href="classStIter.html#c6">CalculateVertexColors</a> ();       
00390         <a class="code" href="classStIter.html#c7">MergeIndirectOpenGLImage</a>();
00391 
00392         <a class="code" href="classStIter.html#o10">time_end</a> = clock ();
00393         <a class="code" href="classStIter.html#o11">duration</a> = (float)(<a class="code" href="classStIter.html#o10">time_end</a> - <a class="code" href="classStIter.html#o9">time_start</a>) / CLOCKS_PER_SEC;
00394         printf(<span class="stringliteral">"Finished rendering.\n\nElapsed time=%2.4f seconds\n"</span>,  duration);
00395 }
00396 
<a name="l00397"></a><a class="code" href="classStIter.html#a3">00397</a> <span class="keywordtype">void</span> <a class="code" href="classStIter.html#a3">StIter::saveImage</a>()
00398 {
00399         <span class="keywordtype">char</span> fname[_MAX_PATH];
00400         _snprintf(fname, _MAX_PATH, <span class="stringliteral">"%s_%d_%d_%d_%2.0fsec_%d_%d.tga"</span>, 
00401                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#a2">getSceneFileName</a>(),
00402                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>,
00403                 <a class="code" href="classStIter.html#o4">m_maxIteration</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z11_2">m_samplesPerLight</a>, <a class="code" href="classStIter.html#o11">duration</a>,
00404                 (long)(<a class="code" href="classStIter.html#o6">m_probPatchSelection_Power</a>*100), (long)(<a class="code" href="classStIter.html#o7">m_probPatchSelection_Importance</a>*100));
00405 
00406         printf(<span class="stringliteral">"Saving image %s\n"</span>, fname);
00407         <a class="code" href="classStIter.html#o1">m_screenBuffer</a>.<a class="code" href="classScreenBuffer.html#a2">Syncronize</a>();
00408         <a class="code" href="classStIter.html#o1">m_screenBuffer</a>.<a class="code" href="classScreenBuffer.html#a8">saveImage</a>(fname);
00409 }
00410 
<a name="l00411"></a><a class="code" href="classStIter.html#c4">00411</a> <span class="keywordtype">bool</span> <a class="code" href="classStIter.html#c4">StIter::DoIteration</a>()
00412 {
00413         <span class="keywordtype">long</span> i; <span class="comment">// receiver patch ID</span>
00414         <span class="keywordtype">long</span> j; <span class="comment">// source patch ID</span>
00415 
00416         <a class="code" href="classVector.html">Vector</a> x;       <span class="comment">// point on the receiver patch</span>
00417         <a class="code" href="classVector.html">Vector</a> y;       <span class="comment">// point on the source patch</span>
00418 
00419         <a class="code" href="classVector.html">Vector</a> w;       <span class="comment">// normalized direction vector pointing (y-&gt;x)</span>
00420 
00421         <a class="code" href="classHitRec.html">HitRec</a> hitRec;
00422         hitRec.<a class="code" href="classHitRec.html#m2">object</a> = NULL;
00423         <a class="code" href="classRay.html">Ray</a> ray;
00424 
00425         <span class="keywordtype">float</span> G;        <span class="comment">// geometric factor</span>
00426         <span class="keywordtype">float</span> costhetax, costhetay;
00427 
00428         <span class="keywordtype">float</span> p1, p2;
00429 
00430         <span class="comment">//w always points y-&gt;x (j-&gt;i)</span>
00431         <span class="comment">//_w points x-&gt;y (i-&gt;j)</span>
00432         <a class="code" href="classVector.html">Vector</a> _w; <span class="comment">// = -w;</span>
00433 
00434         <span class="keywordtype">float</span> r=<a class="code" href="globals_8hpp.html#a9">RAND</a>;
00435         <span class="keywordflow">if</span> (r&lt;<a class="code" href="classStIter.html#o6">m_probPatchSelection_Power</a>) {
00436                 <span class="comment">//Strategy #1</span>
00437                 j = <a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a4">FindDistrib</a>(RAND, m_nIteration);
00438 
00439                 <span class="comment">//select a point on the source patch</span>
00440                 y=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#a5">PointInTriangle</a>();
00441 
00442                 <span class="keywordtype">float</span> pdf_j;
00443                 w=<a class="code" href="classStIter.html#c9">GenerateRadianceDirection</a>(j, pdf_j);
00444 
00445                 ray.<a class="code" href="classRay.html#m2">id</a> = ++ray.<a class="code" href="classRay.html#p0">maxRayID</a>;
00446                 ray.<a class="code" href="classRay.html#m0">origin</a>=y;
00447                 ray.<a class="code" href="classRay.html#m1">dir</a>=w;
00448 
00449                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m2">m_pKDTree</a>-&gt;<a class="code" href="classKDTree.html#a2">traverse</a>(ray, hitRec, 0.0f, FLT_MAX);
00450 
00451                 <span class="keywordflow">if</span>(hitRec.<a class="code" href="classHitRec.html#m2">object</a> == NULL) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00452 
00453                 i=hitRec.<a class="code" href="classHitRec.html#m2">object</a>-&gt;<a class="code" href="classIntersectable.html#m4">m_index</a>;
00454                 x=hitRec.<a class="code" href="classHitRec.html#m0">point</a>;
00455 
00456                 <span class="comment">//Calculate DotProducts</span>
00457                 costhetax = -( w * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a> );  
00458                 costhetay =  ( w * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m3">normal</a> );
00459 
00460                 <span class="comment">// are the patches facing towards each other?</span>
00461                 <span class="keywordflow">if</span> (costhetay&lt;0.0f || costhetax&lt;0.0f) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00462 
00463                 <a class="code" href="classVector.html">Vector</a> yx = x - y;
00464                 G=costhetax*costhetay/yx.<a class="code" href="classVector.html#a19">Norm2</a>();
00465                 _w = -w;
00466 
00467                 <span class="keywordtype">float</span> pPatchSelectionRj=<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)/<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00468                 <span class="keywordtype">float</span> pPatchSelectionRi=<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration)/<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00469                 <span class="keywordtype">float</span> pdf_i = <a class="code" href="classStIter.html#c18">RadianceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i], _w);
00470                 p1 = pPatchSelectionRj * pdf_j / (costhetay*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m8">area</a>) +
00471                         pPatchSelectionRi * pdf_i / (costhetax*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m8">area</a>);
00472 
00473                 pPatchSelectionRj=<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)/<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00474                 pPatchSelectionRi=<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration)/<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00475                 pdf_j = <a class="code" href="classStIter.html#c19">ImportanceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j], w);
00476                 pdf_i = <a class="code" href="classStIter.html#c19">ImportanceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i], _w);
00477                 p2 = pPatchSelectionRj * pdf_j / (costhetay*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m8">area</a>) +
00478                         pPatchSelectionRi * pdf_i / (costhetax*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m8">area</a>);
00479         }
00480         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r&lt;<a class="code" href="classStIter.html#o6">m_probPatchSelection_Power</a>+<a class="code" href="classStIter.html#o7">m_probPatchSelection_Importance</a>) {
00481                 <span class="comment">//Strategy #2</span>
00482                 i = <a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a4">FindDistrib</a>(RAND, m_nIteration);
00483 
00484                 <span class="comment">//select a point on the receiver patch</span>
00485                 x = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#a5">PointInTriangle</a>();
00486 
00487                 ray.<a class="code" href="classRay.html#m2">id</a> = ++ray.<a class="code" href="classRay.html#p0">maxRayID</a>;
00488                 ray.<a class="code" href="classRay.html#m0">origin</a>=x;
00489 
00490                 <span class="keywordtype">float</span> pdf_i;
00491                 ray.<a class="code" href="classRay.html#m1">dir</a>=<a class="code" href="classStIter.html#c10">GenerateImportanceDirection</a>(i, pdf_i);  <span class="comment">//in this case, ray.dir points x-&gt;y;</span>
00492                 w=-ray.<a class="code" href="classRay.html#m1">dir</a>;                                                             <span class="comment">//w always points y-&gt;x</span>
00493 
00494                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m2">m_pKDTree</a>-&gt;<a class="code" href="classKDTree.html#a2">traverse</a>(ray, hitRec, 0.0f, FLT_MAX);
00495                 <span class="keywordflow">if</span>(hitRec.<a class="code" href="classHitRec.html#m2">object</a> == NULL) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00496 
00497                 j=hitRec.<a class="code" href="classHitRec.html#m2">object</a>-&gt;<a class="code" href="classIntersectable.html#m4">m_index</a>;
00498                 <span class="comment">// check if by chance I hit myself due to KD-Tree numerical error</span>
00499                 <span class="keywordflow">if</span> (i==j) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00500                 y=hitRec.<a class="code" href="classHitRec.html#m0">point</a>;
00501 
00502                 <span class="comment">//calculate DotProducts</span>
00503                 costhetax = -( w * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a> );  
00504                 costhetay =  ( w * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m3">normal</a> );
00505 
00506                 <span class="comment">// are the patches facing towards each other?</span>
00507                 <span class="keywordflow">if</span> (costhetay&lt;0.0f || costhetax&lt;0.0f)   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00508 
00509                 <a class="code" href="classVector.html">Vector</a> yx = x - y;
00510                 G=costhetax*costhetay/yx.<a class="code" href="classVector.html#a19">Norm2</a>();
00511 
00512 
00513                 _w = -w;
00514 
00515                 <span class="keywordtype">float</span> pPatchSelectionRj=<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)/<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00516                 <span class="keywordtype">float</span> pPatchSelectionRi=<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration)/<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00517                 <span class="keywordtype">float</span> pdf_j = <a class="code" href="classStIter.html#c19">ImportanceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j], w);
00518                 p2 = pPatchSelectionRj * pdf_j / (costhetay*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m8">area</a>) +
00519                         pPatchSelectionRi * pdf_i / (costhetax*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m8">area</a>);
00520 
00521                 pPatchSelectionRj=<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)/<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00522                 pPatchSelectionRi=<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration)/<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00523                 pdf_i = <a class="code" href="classStIter.html#c18">RadianceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i], _w);
00524                 pdf_j = <a class="code" href="classStIter.html#c18">RadianceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j], w);
00525                 p1 = pPatchSelectionRj * pdf_j / (costhetay*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m8">area</a>) +
00526                         pPatchSelectionRi * pdf_i / (costhetax*<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m8">area</a>);
00527         } <span class="keywordflow">else</span> {
00528                 <span class="comment">// Strategy #3</span>
00529                 j = <a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a4">FindDistrib</a>(RAND, m_nIteration);
00530                 <span class="comment">//select a point on the source patch</span>
00531                 y=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#a5">PointInTriangle</a>();
00532 
00533                 i = <a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a4">FindDistrib</a>(RAND, m_nIteration);
00534                 <span class="comment">//select a point on the receiver patch</span>
00535                 x = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#a5">PointInTriangle</a>();
00536 
00537                 w = x - y;              <span class="comment">//w always points y-&gt;x</span>
00538                 <span class="keywordtype">float</span> yxNorm2 = w.<a class="code" href="classVector.html#a19">Norm2</a>();
00539                 w /= sqrtf(yxNorm2);
00540 
00541                 <span class="comment">//calculate DotProducts</span>
00542                 costhetax = -( w * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a> );
00543                 costhetay =  ( w * <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m3">normal</a> );
00544 
00545                 <span class="comment">// are the patches facing towards each other?</span>
00546                 <span class="keywordflow">if</span> (costhetay&lt; 0 || costhetax&lt; 0 ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00547                                 
00548                 ray.<a class="code" href="classRay.html#m2">id</a> = ++ray.<a class="code" href="classRay.html#p0">maxRayID</a>;
00549                 ray.<a class="code" href="classRay.html#m0">origin</a>=y;
00550                 ray.<a class="code" href="classRay.html#m1">dir</a>=w;              <span class="comment">//in this case, ray.dir points y-&gt;x</span>
00551 
00552                 <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m2">m_pKDTree</a>-&gt;<a class="code" href="classKDTree.html#a2">traverse</a>(ray, hitRec, 0.0f, FLT_MAX);
00553 
00554                 <span class="keywordflow">if</span> (hitRec.<a class="code" href="classHitRec.html#m2">object</a> == NULL) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00555                 <span class="keywordflow">if</span> (i != hitRec.<a class="code" href="classHitRec.html#m2">object</a>-&gt;<a class="code" href="classIntersectable.html#m4">m_index</a>) {
00556                         <span class="comment">//we found a different patch, path i and patch j are not visible</span>
00557                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00558                 }
00559                         
00560                 G=costhetax*costhetay/yxNorm2;
00561 
00562                 _w = -w;
00563 
00564                 <span class="keywordtype">float</span> pPatchSelectionRj=<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)/<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00565                 <span class="keywordtype">float</span> pPatchSelectionRi=<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration)/<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00566                 <span class="keywordtype">float</span> pdf_i = <a class="code" href="classStIter.html#c18">RadianceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i], _w);
00567                 <span class="keywordtype">float</span> pdf_j = <a class="code" href="classStIter.html#c18">RadianceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j], w);
00568                 p1 = pPatchSelectionRj * pdf_j / <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m8">area</a> +
00569                         pPatchSelectionRi * pdf_i / <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m8">area</a>;
00570 
00571                 pPatchSelectionRj=<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)/<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00572                 pPatchSelectionRi=<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration)/<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00573                 pdf_j = <a class="code" href="classStIter.html#c19">ImportanceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j], w);
00574                 pdf_i = <a class="code" href="classStIter.html#c19">ImportanceDirectionProbability</a>(&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i], _w);
00575                 p2 = pPatchSelectionRj * pdf_j / <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m8">area</a> +
00576                         pPatchSelectionRi * pdf_i / <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m8">area</a>;
00577 
00578         }
00579 
00580         <span class="keywordflow">if</span> (!_finite(G) || G&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00581 
00582 
00583         <span class="comment">// Areas</span>
00584         <span class="keywordtype">float</span> Ai=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m8">area</a>;
00585         <span class="keywordtype">float</span> Aj=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m8">area</a>;
00586 
00587         <span class="keywordtype">float</span> fi=<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00588         <span class="keywordtype">float</span> lambda=<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a8">getRootValue</a>(m_nIteration);
00589 
00590         <span class="comment">//specular albedo</span>
00591         <a class="code" href="classVector.html">Color</a> da_i=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(w,<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a>);
00592         <span class="keywordtype">float</span> Lum_da_i = da_i.<a class="code" href="classVector.html#a28">Average</a>();
00593 
00594         <span class="comment">//specular albedo</span>
00595         <a class="code" href="classVector.html">Color</a> da_j=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(_w,<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m3">normal</a>);
00596         <span class="keywordtype">float</span> Lum_da_j = da_j.<a class="code" href="classVector.html#a28">Average</a>();
00597 
00598         <span class="comment">//diffuse BRDF</span>
00599         <a class="code" href="classVector.html">Color</a> fd_i=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a8">GetDiffuseBrdf</a>();
00600         <a class="code" href="classVector.html">Color</a> fd_j=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a8">GetDiffuseBrdf</a>();
00601 
00602         <a class="code" href="classVector.html">Color</a> Le_i, Le_j;       <span class="comment">// radiance emittance</span>
00603         <a class="code" href="classVector.html">Color</a> L_i=<a class="code" href="classStIter.html#c12">getRadiance</a>(i, _w, Le_i); <a class="code" href="classVector.html">Color</a> L_j=<a class="code" href="classStIter.html#c12">getRadiance</a>(j, w, Le_j);
00604         <span class="keywordtype">float</span> R_i=<a class="code" href="classStIter.html#c13">getImportance</a>(i, _w); <span class="keywordtype">float</span> R_j=<a class="code" href="classStIter.html#c13">getImportance</a>(j, w);
00605 
00606         p1*=G;
00607         p2*=G;
00608 
00609         <span class="keywordtype">float</span> p3=(<a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration)*<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)+
00610                 <a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(j, m_nIteration)*<a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a7">getValue2</a>(i, m_nIteration))
00611                 /(Ai*Aj*lambda*fi);
00612 
00613         <span class="comment">//d = P1*p1+P2*p2+P3*p3</span>
00614         <span class="keywordtype">float</span> d = <a class="code" href="classStIter.html#o6">m_probPatchSelection_Power</a>*p1+<a class="code" href="classStIter.html#o7">m_probPatchSelection_Importance</a>*p2+<a class="code" href="classStIter.html#o8">m_probPatchSelection_Mix</a>*p3;
00615         <span class="keywordflow">if</span> (!_finite(d) || d&lt;1e-10f) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00616 
00617         <a class="code" href="classVector.html">Color</a>   newI_i = L_j*G/(Ai*d);          <a class="code" href="classVector.html">Color</a>   newI_j = L_i*G/(Aj*d);
00618         <span class="keywordtype">float</span>   newW_i = R_j*G/(Ai*d);          <span class="keywordtype">float</span>   newW_j = R_i*G/(Aj*d);
00619 
00620 
00621         <a class="code" href="classVector.html">Color</a> f=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a0">EvalBrdf</a>(w, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m10">m_VisDir</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m3">normal</a>, costhetax);
00622         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m12">Leye</a> += ((L_j-Le_j)*G/(Ai*d)) % f;
00623 
00624         f=<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a0">EvalBrdf</a>(_w, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m10">m_VisDir</a>, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classTriangle.html#m3">normal</a>, costhetay);
00625         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m12">Leye</a> += ((L_i-Le_i)*G/(Aj*d)) % f;
00626 
00627         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m3">C_I</a> += (newI_i % da_i).Average();     
00628         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m3">C_I</a> += (newI_j % da_j).Average();
00629 
00630         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m7">C_W</a> += newW_i * Lum_da_i;                             
00631         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m7">C_W</a> += newW_j * Lum_da_j;
00632 
00633         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m2">Ld</a>  += newI_i % fd_i;                 
00634         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m2">Ld</a>  += newI_j % fd_j;
00635 
00636         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m6">Rd</a>+= newW_i * fd_i.<a class="code" href="classVector.html#a28">Average</a>(); 
00637         <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m6">Rd</a>+= newW_j * fd_j.<a class="code" href="classVector.html#a28">Average</a>();
00638 
00639         <span class="comment">//Accept or reject new newI_i, newI_j, newW_i, newW_j values</span>
00640         <a class="code" href="classStIter.html#c14">Accept</a>(<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m4">I</a>, newI_i, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m5">dirI</a>, w, da_i);
00641         <a class="code" href="classStIter.html#c14">Accept</a>(<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m4">I</a>, newI_j, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m5">dirI</a>, _w, da_j);
00642 
00643         <a class="code" href="classStIter.html#c14">Accept</a>(<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m8">W</a>, newW_i, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classPatch.html#m9">dirW</a>, w);
00644         <a class="code" href="classStIter.html#c14">Accept</a>(<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m8">W</a>, newW_j, <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[j].<a class="code" href="classPatch.html#m9">dirW</a>, _w);
00645 
00646         <a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a3">Update</a>(i);
00647         <a class="code" href="classStIter.html#o3">m_pPowerTree</a>-&gt;<a class="code" href="classSelectionTree.html#a3">Update</a>(j);
00648 
00649         <a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a3">Update</a>(i);
00650         <a class="code" href="classStIter.html#o2">m_pImportanceTree</a>-&gt;<a class="code" href="classSelectionTree.html#a3">Update</a>(j);
00651 
00652         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00653 }
00654 
<a name="l00655"></a><a class="code" href="classStIter.html#c16">00655</a> <span class="keywordtype">float</span> <a class="code" href="classStIter.html#c16">StIter::CalculateSpecularDirectionProbability</a>(<a class="code" href="classPatch.html">Patch</a>* p, <span class="keywordtype">float</span> value, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; indir, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; outdir)
00656 {
00657         <span class="keywordflow">if</span> (value&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) <span class="keywordflow">return</span> 0.0f;
00658 
00659         <a class="code" href="classVector.html">Vector</a> idealReflDir;
00660         idealReflDir.<a class="code" href="classVector.html#a29">SetIdealReflectedDirection</a> (indir, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00661         <span class="keywordflow">return</span> <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, value, indir, outdir, idealReflDir);
00662 }
00663 
<a name="l00664"></a><a class="code" href="classStIter.html#c17">00664</a> <span class="keywordtype">float</span> <a class="code" href="classStIter.html#c16">StIter::CalculateSpecularDirectionProbability</a>(<a class="code" href="classPatch.html">Patch</a>* p, <span class="keywordtype">float</span> value, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; indir, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; outdir, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; idealReflDir)
00665 {
00666         <span class="keywordflow">if</span> (value&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) <span class="keywordflow">return</span> 0.0f;
00667 
00668         <span class="keywordtype">float</span> specPdf;
00669 
00670         <span class="keywordtype">float</span>   cos_ideal = idealReflDir * outdir;
00671         <span class="keywordflow">if</span> (cos_ideal &gt; 0)
00672                 specPdf = powf (cos_ideal, p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#m4">Ns</a>) * p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#m8">specularPdfScaling</a>;
00673         <span class="keywordflow">else</span>
00674                 specPdf = 0.0f;
00675 
00676         <span class="keywordflow">return</span> specPdf;
00677 }
00678 
<a name="l00679"></a><a class="code" href="classStIter.html#c11">00679</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="classStIter.html#c11">StIter::GenerateSpecularDirection</a>(<a class="code" href="classPatch.html">Patch</a>* p, <span class="keywordtype">float</span> value, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; indir, <span class="keywordtype">float</span>&amp; specPdf)
00680 {
00681         <a class="code" href="classVector.html">Vector</a> outdir;
00682 
00683         <span class="comment">//specular direction selection strategy</span>
00684         <a class="code" href="classCPhongBrdf.html">CPhongBrdf</a>*     brdf = p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>;
00685         <a class="code" href="classVector.html">Vector</a> idealReflDir;
00686         idealReflDir.<a class="code" href="classVector.html#a29">SetIdealReflectedDirection</a> (indir, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00687 
00688         <span class="keywordflow">for</span> (;;) {
00689                 idealReflDir.<a class="code" href="classVector.html#a34">SampleHemisphereCosNTheta</a>(brdf-&gt;<a class="code" href="classCPhongBrdf.html#m4">Ns</a>, brdf-&gt;<a class="code" href="classCPhongBrdf.html#m8">specularPdfScaling</a>, outdir, specPdf);
00690                 <span class="keywordtype">float</span> cosx=outdir * p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>;  <span class="comment">//DotProduct</span>
00691                 <span class="keywordflow">if</span> (cosx&gt;0) <span class="keywordflow">break</span>;
00692         }
00693 
00694         outdir.<a class="code" href="classVector.html#a20">Normalize</a>();
00695         specPdf = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, value, indir, outdir, idealReflDir);
00696         <span class="keywordflow">return</span> outdir;
00697 }
00698 
<a name="l00699"></a><a class="code" href="classStIter.html#c18">00699</a> <span class="keywordtype">float</span> <a class="code" href="classStIter.html#c18">StIter::RadianceDirectionProbability</a>(<a class="code" href="classPatch.html">Patch</a>* p, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; outdir)
00700 {
00701         <span class="keywordtype">float</span> sePower = <a class="code" href="classStIter.html#o5">m_nIteration</a>*<a class="code" href="globals_8hpp.html#a2">M_PI</a>*(p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a> ? p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a>-&gt;<a class="code" href="classCPhongEdf.html#a2">GetEmissionLum</a>() : 0.0f);
00702         <span class="keywordtype">float</span> sdPower = <a class="code" href="globals_8hpp.html#a2">M_PI</a>*p-&gt;<a class="code" href="classPatch.html#m2">Ld</a>.<a class="code" href="classVector.html#a28">Average</a>();
00703 
00704         <a class="code" href="classVector.html">Color</a> Ks=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(outdir, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00705         <span class="keywordtype">float</span> ssPower = (Ks % p-&gt;<a class="code" href="classPatch.html#m4">I</a>).Average()*p-&gt;<a class="code" href="classPatch.html#m3">C_I</a>;
00706         <span class="keywordtype">float</span> ss=sePower+sdPower+ssPower;
00707 
00708         <span class="keywordflow">if</span> (ss&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) <span class="keywordflow">return</span> 0.0f;
00709 
00710         <span class="keywordtype">float</span> cosTheta = p-&gt;<a class="code" href="classTriangle.html#m3">normal</a> * outdir;
00711         <span class="keywordtype">float</span> diffPdf = cosTheta / <a class="code" href="globals_8hpp.html#a2">M_PI</a>;
00712         <span class="keywordtype">float</span> specPdf = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, p-&gt;<a class="code" href="classPatch.html#m3">C_I</a>, p-&gt;<a class="code" href="classPatch.html#m5">dirI</a>, outdir);
00713         <span class="keywordtype">float</span> pdf = specPdf * ssPower/ss + diffPdf* (1.0f-ssPower/ss);
00714         
00715         <span class="keywordflow">return</span> pdf;
00716 }
00717 
<a name="l00718"></a><a class="code" href="classStIter.html#c19">00718</a> <span class="keywordtype">float</span> <a class="code" href="classStIter.html#c19">StIter::ImportanceDirectionProbability</a>(<a class="code" href="classPatch.html">Patch</a>* p, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; outdir)
00719 {
00720         <a class="code" href="classVector.html">Color</a> Ks=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(outdir, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00721 
00722         <span class="keywordtype">float</span> srdImportance,srsImportance;
00723         <span class="keywordtype">float</span> sedImportance=0.0f;       <span class="comment">// 'emissive' diffuse importance</span>
00724         <span class="keywordtype">float</span> sesImportance=0.0f;       <span class="comment">// 'emissive' specular importance</span>
00725         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classPatch.html#m0">visible</a>) {
00726                 <a class="code" href="classVector.html">Color</a> Kd=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a10">GetDiffuseAlbedo</a>();
00727 
00728                 sedImportance = <a class="code" href="globals_8hpp.html#a2">M_PI</a>*Kd.<a class="code" href="classVector.html#a28">Average</a>()*<a class="code" href="classStIter.html#o5">m_nIteration</a>;
00729                 sesImportance = Ks.<a class="code" href="classVector.html#a28">Average</a>()*<a class="code" href="classStIter.html#o5">m_nIteration</a>;
00730         };
00731         srdImportance = <a class="code" href="globals_8hpp.html#a2">M_PI</a>*p-&gt;<a class="code" href="classPatch.html#m6">Rd</a>;
00732         srsImportance = p-&gt;<a class="code" href="classPatch.html#m7">C_W</a>*(Ks * p-&gt;<a class="code" href="classPatch.html#m8">W</a>).Average();
00733 
00734         <span class="keywordtype">float</span> diffPdf, specPdf1, specPdf2;
00735 
00736         <span class="keywordtype">float</span> sum_sImportance=sedImportance+sesImportance+srdImportance+srsImportance;
00737         <span class="keywordflow">if</span> (sum_sImportance&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) <span class="keywordflow">return</span> 0.0f;
00738 
00739         <span class="keywordtype">float</span> pDiffuse=(sedImportance+srdImportance)/sum_sImportance;
00740         <span class="keywordtype">float</span> p1=srsImportance/sum_sImportance;
00741         <span class="keywordtype">float</span> p2=sesImportance/sum_sImportance;
00742 
00743         specPdf1 = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, p-&gt;<a class="code" href="classPatch.html#m7">C_W</a>, p-&gt;<a class="code" href="classPatch.html#m9">dirW</a>, outdir);
00744         specPdf2 = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, 1.0f, p-&gt;<a class="code" href="classPatch.html#m11">m_EyePatchDir</a>, outdir);
00745         <span class="keywordtype">float</span> cosTheta = p-&gt;<a class="code" href="classTriangle.html#m3">normal</a> * outdir;
00746         diffPdf = cosTheta / <a class="code" href="globals_8hpp.html#a2">M_PI</a>;
00747 
00748         <span class="keywordtype">float</span> pdf= pDiffuse * diffPdf + p1 * specPdf1 + p2* specPdf2;
00749 
00750         <span class="keywordflow">return</span> pdf;
00751 }
00752 
<a name="l00753"></a><a class="code" href="classStIter.html#c9">00753</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="classStIter.html#c9">StIter::GenerateRadianceDirection</a>(<span class="keywordtype">long</span> patchIndex, <span class="keywordtype">float</span>&amp; pdf)
00754 {
00755         <a class="code" href="classPatch.html">Patch</a>* p=&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[patchIndex];
00756         <span class="keywordtype">float</span> sePower = <a class="code" href="classStIter.html#o5">m_nIteration</a>*<a class="code" href="globals_8hpp.html#a2">M_PI</a>*(p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a> ? p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a>-&gt;<a class="code" href="classCPhongEdf.html#a2">GetEmissionLum</a>() : 0.0f);
00757         <span class="keywordtype">float</span> sdPower = <a class="code" href="globals_8hpp.html#a2">M_PI</a>*p-&gt;<a class="code" href="classPatch.html#m2">Ld</a>.<a class="code" href="classVector.html#a28">Average</a>();
00758 
00759         <a class="code" href="classVector.html">Color</a> Ks=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(p-&gt;<a class="code" href="classPatch.html#m5">dirI</a>, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00760         <span class="keywordtype">float</span> ssPower = (Ks % p-&gt;<a class="code" href="classPatch.html#m4">I</a>).Average()*p-&gt;<a class="code" href="classPatch.html#m3">C_I</a>;
00761         <span class="keywordtype">float</span> ss=sePower+sdPower+ssPower;
00762 
00763         <a class="code" href="classVector.html">Vector</a> outdir;
00764         <span class="keywordtype">float</span> specPdf;
00765         <span class="keywordtype">float</span> diffPdf;
00766 
00767         <span class="keywordflow">if</span> (<a class="code" href="globals_8hpp.html#a9">RAND</a>&lt;ssPower/ss) {
00768                 <span class="comment">//specular direction selection strategy</span>
00769                 outdir=<a class="code" href="classStIter.html#c11">GenerateSpecularDirection</a>(p, p-&gt;<a class="code" href="classPatch.html#m3">C_I</a>, p-&gt;<a class="code" href="classPatch.html#m5">dirI</a>, specPdf);
00770                 <span class="keywordtype">float</span> cosTheta = p-&gt;<a class="code" href="classTriangle.html#m3">normal</a> * outdir;
00771                 diffPdf = cosTheta / <a class="code" href="globals_8hpp.html#a2">M_PI</a>;
00772         } <span class="keywordflow">else</span> 
00773         {
00774                 <span class="comment">//diffuse direction selection strategy</span>
00775                 p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#a33">SampleHemisphereCosTheta</a>(outdir, diffPdf);
00776                 outdir.<a class="code" href="classVector.html#a20">Normalize</a>();
00777 
00778                 specPdf = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, p-&gt;<a class="code" href="classPatch.html#m3">C_I</a>, p-&gt;<a class="code" href="classPatch.html#m5">dirI</a>, outdir);
00779         }
00780 
00781         pdf = specPdf * ssPower/ss + diffPdf* (1.0f-(ssPower)/ss);
00782         <span class="keywordflow">return</span> outdir;
00783 }
00784 
<a name="l00785"></a><a class="code" href="classStIter.html#c10">00785</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="classStIter.html#c10">StIter::GenerateImportanceDirection</a>(<span class="keywordtype">long</span> patchIndex, <span class="keywordtype">float</span>&amp; pdf)
00786 {
00787         <a class="code" href="classPatch.html">Patch</a>* p=&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[patchIndex];
00788 
00789         <span class="keywordtype">float</span> srdImportance,srsImportance;
00790         <span class="keywordtype">float</span> sedImportance=0.0f;       <span class="comment">// 'emissive' diffuse importance</span>
00791         <span class="keywordtype">float</span> sesImportance=0.0f;       <span class="comment">// 'emissive' specular importance</span>
00792         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classPatch.html#m0">visible</a>) {
00793                 <a class="code" href="classVector.html">Color</a> Kd=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a10">GetDiffuseAlbedo</a>();
00794                 <a class="code" href="classVector.html">Color</a> Ks=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(p-&gt;<a class="code" href="classPatch.html#m11">m_EyePatchDir</a>, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00795 
00796                 sedImportance = <a class="code" href="globals_8hpp.html#a2">M_PI</a>*Kd.<a class="code" href="classVector.html#a28">Average</a>()*<a class="code" href="classStIter.html#o5">m_nIteration</a>;
00797                 sesImportance = Ks.<a class="code" href="classVector.html#a28">Average</a>()*<a class="code" href="classStIter.html#o5">m_nIteration</a>;
00798         };
00799 
00800         <a class="code" href="classVector.html">Color</a> Ks=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(p-&gt;<a class="code" href="classPatch.html#m9">dirW</a>, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00801         srdImportance = <a class="code" href="globals_8hpp.html#a2">M_PI</a>*p-&gt;<a class="code" href="classPatch.html#m6">Rd</a>;
00802         srsImportance = p-&gt;<a class="code" href="classPatch.html#m7">C_W</a>*(Ks * p-&gt;<a class="code" href="classPatch.html#m8">W</a>).Average();
00803 
00804         <a class="code" href="classVector.html">Vector</a> outdir;
00805 
00806         <span class="keywordtype">float</span> diffPdf, specPdf1, specPdf2;
00807         <span class="keywordtype">float</span> sum_sImportance = sedImportance+srdImportance+srsImportance+sesImportance;
00808 
00809         <span class="keywordtype">float</span> p1=(sedImportance+srdImportance)/sum_sImportance;
00810         <span class="keywordtype">float</span> p2=srsImportance/sum_sImportance;
00811         <span class="keywordtype">float</span> p3=sesImportance/sum_sImportance;
00812 
00813         <span class="keywordtype">float</span> r=<a class="code" href="globals_8hpp.html#a9">RAND</a>;
00814         <span class="keywordflow">if</span> (r&lt; p1) {
00815                 <span class="comment">//diffuse direction selection strategy</span>
00816                 p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>.<a class="code" href="classVector.html#a33">SampleHemisphereCosTheta</a> (outdir, diffPdf);
00817                 outdir.<a class="code" href="classVector.html#a20">Normalize</a>();
00818 
00819                 specPdf1 = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, p-&gt;<a class="code" href="classPatch.html#m7">C_W</a>, p-&gt;<a class="code" href="classPatch.html#m9">dirW</a>, outdir);
00820                 specPdf2 = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, 1.0f, p-&gt;<a class="code" href="classPatch.html#m11">m_EyePatchDir</a>, outdir);
00821         }
00822         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r&lt;(p1+p2)) {
00823                 outdir = <a class="code" href="classStIter.html#c11">GenerateSpecularDirection</a>(p, p-&gt;<a class="code" href="classPatch.html#m7">C_W</a>, p-&gt;<a class="code" href="classPatch.html#m9">dirW</a>, specPdf1);
00824                 <span class="keywordtype">float</span> cosTheta = p-&gt;<a class="code" href="classTriangle.html#m3">normal</a> * outdir;
00825                 diffPdf = cosTheta / <a class="code" href="globals_8hpp.html#a2">M_PI</a>;
00826                 specPdf2 = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, 1.0f, p-&gt;<a class="code" href="classPatch.html#m11">m_EyePatchDir</a>, outdir);
00827         } <span class="keywordflow">else</span> {
00828                 outdir = <a class="code" href="classStIter.html#c11">GenerateSpecularDirection</a>(p, 1.0f, p-&gt;<a class="code" href="classPatch.html#m11">m_EyePatchDir</a>, specPdf2);
00829                 <span class="keywordtype">float</span> cosTheta = p-&gt;<a class="code" href="classTriangle.html#m3">normal</a> * outdir;
00830                 diffPdf = cosTheta / <a class="code" href="globals_8hpp.html#a2">M_PI</a>;
00831                 specPdf1 = <a class="code" href="classStIter.html#c16">CalculateSpecularDirectionProbability</a>(p, p-&gt;<a class="code" href="classPatch.html#m7">C_W</a>, p-&gt;<a class="code" href="classPatch.html#m9">dirW</a>, outdir);
00832         }
00833 
00834         pdf = diffPdf * p1 + specPdf1 * p2 + specPdf2 * p3;
00835         <span class="keywordflow">return</span> outdir;
00836 }
00837 
<a name="l00838"></a><a class="code" href="classStIter.html#c12">00838</a> <a class="code" href="classVector.html">Color</a> <a class="code" href="classStIter.html#c12">StIter::getRadiance</a>(<span class="keywordtype">long</span> patchIndex, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; outdir, <a class="code" href="classVector.html">Color</a>&amp; emission)
00839 {
00840         <a class="code" href="classPatch.html">Patch</a>* p=&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[patchIndex];
00841         <a class="code" href="classVector.html">Color</a> L=p-&gt;<a class="code" href="classPatch.html#m2">Ld</a>/(float)<a class="code" href="classStIter.html#o5">m_nIteration</a>;
00842 
00843         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classPatch.html#m3">C_I</a>&gt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) {
00844                 <a class="code" href="classCPhongBrdf.html">CPhongBrdf</a>* Brdf = p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>;
00845                 
00846                 <a class="code" href="classVector.html">Color</a> f=Brdf-&gt;<a class="code" href="classCPhongBrdf.html#a5">EvalSpecularBrdf</a> (p-&gt;<a class="code" href="classPatch.html#m5">dirI</a>, outdir, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00847                 <a class="code" href="classVector.html">Color</a> Ks=Brdf-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(p-&gt;<a class="code" href="classPatch.html#m5">dirI</a>, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00848 
00849                 <span class="keywordtype">float</span> q=(p-&gt;<a class="code" href="classPatch.html#m4">I</a> % Ks).Average()*m_nIteration/p-&gt;<a class="code" href="classPatch.html#m3">C_I</a>;
00850                 <span class="keywordflow">if</span> (q&gt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) {
00851                         L+=(f % p-&gt;<a class="code" href="classPatch.html#m4">I</a>) / q;
00852                 }
00853         }
00854 
00855         <span class="comment">// if it is a lightSource, add emittance power to reflected power</span>
00856         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a> != NULL) {    
00857                 emission=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a>-&gt;<a class="code" href="classCPhongEdf.html#a3">GetEmissionRad</a>();
00858                 L += emission;
00859         } <span class="keywordflow">else</span> {
00860                 emission=Color::BLACK;
00861         }
00862 
00863         <span class="keywordflow">return</span> L;
00864 }
00865 
00866 
<a name="l00867"></a><a class="code" href="classStIter.html#c13">00867</a> <span class="keywordtype">float</span> <a class="code" href="classStIter.html#c13">StIter::getImportance</a>(<span class="keywordtype">long</span> patchIndex, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>&amp; outdir)
00868 {
00869         <span class="keywordtype">float</span> R=0.0f;
00870 
00871         <a class="code" href="classPatch.html">Patch</a>* p=&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[patchIndex];
00872         <a class="code" href="classCPhongBrdf.html">CPhongBrdf</a>* Brdf = p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m0">m_brdf</a>;
00873 
00874         <span class="comment">// if the patch is directly visible from the eye,</span>
00875         <span class="comment">// we consider it's incoming importance 1.0f</span>
00876         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classPatch.html#m0">visible</a>) {
00877                 <a class="code" href="classVector.html">Color</a> f = Brdf-&gt;<a class="code" href="classCPhongBrdf.html#a0">EvalBrdf</a> (p-&gt;<a class="code" href="classPatch.html#m11">m_EyePatchDir</a>, outdir, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00878                 R = f.<a class="code" href="classVector.html#a28">Average</a>();
00879         }
00880 
00881         R+=(p-&gt;<a class="code" href="classPatch.html#m6">Rd</a>/<a class="code" href="classStIter.html#o5">m_nIteration</a>);
00882 
00883         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classPatch.html#m8">W</a>&gt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) {
00884                 <a class="code" href="classVector.html">Color</a> Ks=Brdf-&gt;<a class="code" href="classCPhongBrdf.html#a14">ComputedSpecularMaxPhongAlbedo</a>(p-&gt;<a class="code" href="classPatch.html#m9">dirW</a>, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00885                 <span class="keywordtype">float</span> KsAvg=Ks.<a class="code" href="classVector.html#a28">Average</a>();
00886 
00887                 <span class="keywordflow">if</span> (KsAvg&gt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) {
00888                         <a class="code" href="classVector.html">Color</a> f=Brdf-&gt;<a class="code" href="classCPhongBrdf.html#a5">EvalSpecularBrdf</a>(p-&gt;<a class="code" href="classPatch.html#m9">dirW</a>, outdir, p-&gt;<a class="code" href="classTriangle.html#m3">normal</a>);
00889                         <span class="keywordtype">float</span> _f = f.<a class="code" href="classVector.html#a28">Average</a>();
00890                         R += p-&gt;<a class="code" href="classPatch.html#m8">W</a>/(p-&gt;<a class="code" href="classPatch.html#m8">W</a>*KsAvg)*p-&gt;<a class="code" href="classPatch.html#m7">C_W</a>*_f/<a class="code" href="classStIter.html#o5">m_nIteration</a>;
00891                 }
00892         }
00893 
00894         <span class="keywordflow">return</span> R;
00895 }
00896 
<a name="l00897"></a><a class="code" href="classStIter.html#c14">00897</a> <span class="keywordtype">void</span>    <a class="code" href="classStIter.html#c14">StIter::Accept</a>(<a class="code" href="classVector.html">Color</a>&amp; _old, <a class="code" href="classVector.html">Color</a>&amp; _new, <a class="code" href="classVector.html">Vector</a>&amp; vOld, <a class="code" href="classVector.html">Vector</a>&amp; vNew, <a class="code" href="classVector.html">Color</a>&amp; Ks ) 
00898 {
00899         <span class="keywordtype">float</span> o=(_old % Ks).Average();
00900         <span class="keywordflow">if</span> (o&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a> || <a class="code" href="globals_8hpp.html#a9">RAND</a> &lt; (_new % Ks).Average()/o) {
00901                 _old = _new; 
00902                 vOld = vNew;
00903         }
00904 }
00905 
<a name="l00906"></a><a class="code" href="classStIter.html#c15">00906</a> <span class="keywordtype">void</span>    <a class="code" href="classStIter.html#c14">StIter::Accept</a>(<span class="keywordtype">float</span>&amp; _old, <span class="keywordtype">float</span>&amp; _new, <a class="code" href="classVector.html">Vector</a>&amp; vOld, <a class="code" href="classVector.html">Vector</a>&amp; vNew) 
00907 {
00908         <span class="keywordtype">float</span> o=_old;
00909         <span class="keywordflow">if</span> (o&lt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a> || <a class="code" href="globals_8hpp.html#a9">RAND</a> &lt; _new/o) {
00910                 _old = _new; 
00911                 vOld = vNew;
00912         }
00913 }
00914 
00915 <span class="comment">//--------------------------------------</span>
00916 
<a name="l00917"></a><a class="code" href="classStIter.html#c5">00917</a> <span class="keywordtype">void</span>    <a class="code" href="classStIter.html#c5">StIter::FinalizeLtoEye</a> (<span class="keywordtype">void</span>)
00918 {       
00919         <span class="keywordtype">float</span> scale = 1.0f/<a class="code" href="classStIter.html#o5">m_nIteration</a>;
00920         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i = 0; i &lt; <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>; i++) {
00921                 <a class="code" href="classPatch.html">Patch</a>* p = &amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i];
00922                 p-&gt;<a class="code" href="classPatch.html#m12">Leye</a> *= scale;
00923                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a> != NULL) {
00924                         p-&gt;<a class="code" href="classPatch.html#m12">Leye</a>+=p-&gt;<a class="code" href="classIntersectable.html#m0">m_pMaterial</a>-&gt;<a class="code" href="classMaterial.html#m1">m_edf</a>-&gt;<a class="code" href="classCPhongEdf.html#a3">GetEmissionRad</a>();
00925                 }
00926         }       <span class="comment">// for</span>
00927 }
00928 
<a name="l00929"></a><a class="code" href="classStIter.html#c6">00929</a> <span class="keywordtype">void</span>    <a class="code" href="classStIter.html#c6">StIter::CalculateVertexColors</a> (<span class="keywordtype">void</span>)
00930 {
00931         <span class="keywordtype">long</span> nSceneVertices = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_2">nSceneVertices</a>;
00932         <span class="keywordtype">long</span>* vertexColorsInc = <span class="keyword">new</span> <span class="keywordtype">long</span>[nSceneVertices];
00933 
00934         <span class="comment">// compute vertex colors with Goaroud shading</span>
00935         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i=0; i&lt;nSceneVertices; i++) {
00936                 <a class="code" href="classStIter.html#o12">m_vertexColors</a>[i] = Color::BLACK;
00937                 vertexColorsInc[i] = 0;
00938         }
00939         
00940         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>; i++) {
00941                 <a class="code" href="classPatch.html">Patch</a>* p=&amp;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i];
00942                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classTriangle.html#m8">area</a>&gt;<a class="code" href="globals_8hpp.html#a0">EPSILON</a>) {
00943                         <span class="keywordtype">long</span> vertIndex = (long)(p-&gt;<a class="code" href="classTriangle.html#m0">a</a> - <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_0">sceneVertices</a>);
00944                         <a class="code" href="classStIter.html#o12">m_vertexColors</a>[vertIndex]+=p-&gt;<a class="code" href="classPatch.html#m12">Leye</a>;
00945                         vertexColorsInc[vertIndex]++;
00946                         
00947                         vertIndex = (long)(p-&gt;<a class="code" href="classTriangle.html#m1">b</a> - <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_0">sceneVertices</a>);
00948                         <a class="code" href="classStIter.html#o12">m_vertexColors</a>[vertIndex]+= p-&gt;<a class="code" href="classPatch.html#m12">Leye</a>;
00949                         vertexColorsInc[vertIndex]++;
00950                         
00951                         vertIndex = (long)(p-&gt;<a class="code" href="classTriangle.html#m2">c</a> - <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_0">sceneVertices</a>);
00952                         <a class="code" href="classStIter.html#o12">m_vertexColors</a>[vertIndex]+= p-&gt;<a class="code" href="classPatch.html#m12">Leye</a>;
00953                         vertexColorsInc[vertIndex]++;
00954                 }
00955         }
00956         
00957         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_2">nSceneVertices</a>; i++) {
00958                 <span class="keywordflow">if</span> (vertexColorsInc[i] &gt;0) {
00959                         <a class="code" href="classStIter.html#o12">m_vertexColors</a>[i]*=1.0f/vertexColorsInc[i];
00960                 }
00961         }
00962 
00963         <span class="keyword">delete</span>[] vertexColorsInc;
00964 }
00965 
<a name="l00966"></a><a class="code" href="classStIter.html#c7">00966</a> <span class="keywordtype">void</span> <a class="code" href="classStIter.html#c7">StIter::MergeIndirectOpenGLImage</a>()
00967 {
00968         <span class="keyword">const</span> <a class="code" href="classCamera.html">Camera</a>&amp; camera = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>;
00969 
00970         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* Image= <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[3 * (camera.<a class="code" href="classCamera.html#m9">hres</a> + 1) * (camera.<a class="code" href="classCamera.html#m10">vres</a> + 1)];
00971 
00972         BYTE* m_pBitmapBits;
00973 <span class="comment"></span>
00974 <span class="comment">        //! memory device context</span>
00975 <span class="comment"></span>        HDC     DC = ::CreateCompatibleDC(NULL);
00976 
00977         BITMAPINFO                              bmi;
00978         memset (&amp;bmi, 0, <span class="keyword">sizeof</span>(BITMAPINFO));
00979         bmi.bmiHeader.biSize                    = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
00980         bmi.bmiHeader.biWidth                   = camera.<a class="code" href="classCamera.html#m9">hres</a>;
00981         bmi.bmiHeader.biHeight                  = camera.<a class="code" href="classCamera.html#m10">vres</a>;
00982         bmi.bmiHeader.biPlanes                  = 1;
00983         bmi.bmiHeader.biBitCount                = 24;
00984         bmi.bmiHeader.biCompression             = BI_RGB;
00985         bmi.bmiHeader.biSizeImage               = camera.<a class="code" href="classCamera.html#m9">hres</a> * camera.<a class="code" href="classCamera.html#m10">vres</a> * 3;
00986 <span class="comment"></span>
00987 <span class="comment">        //! the DIB format bitmap</span>
00988 <span class="comment"></span>        HBITMAP hDib = ::CreateDIBSection (DC, &amp;bmi, DIB_RGB_COLORS, (<span class="keywordtype">void</span>**)&amp;m_pBitmapBits, NULL, (DWORD)0);
00989         SelectObject (DC, hDib);
00990         
00991         <span class="keywordtype">bool</span> res=<a class="code" href="classStIter.html#c1">SetWindowPixelFormat</a> (DC, PFD_DRAW_TO_BITMAP | PFD_SUPPORT_OPENGL | PFD_STEREO_DONTCARE, 24);<span class="comment"></span>
00992 <span class="comment">        //! memory rendering context</span>
00993 <span class="comment"></span>        HGLRC RC = wglCreateContext (DC);
00994 
00995         <span class="keywordflow">if</span> (RC==NULL) 
00996                 <span class="keywordflow">return</span>;
00997 
00998         <span class="keywordflow">if</span> (wglMakeCurrent (DC, RC)==FALSE) <span class="keywordflow">return</span>;
00999 
01000         <span class="comment">// Default mode</span>
01001         glEnable (GL_NORMALIZE);
01002         
01003         <span class="comment">// Lights, material properties</span>
01004         glClearColor (0, 0, 0, 0);
01005         glClearDepth (1.0);
01006         
01007         glEnable (GL_CULL_FACE);
01008         glPolygonMode (GL_FRONT, GL_FILL);              
01009 
01010 
01011     glEnable (GL_DEPTH_TEST);   <span class="comment">// z-buffer</span>
01012     glDisable (GL_DITHER);              <span class="comment">// no dither</span>
01013         
01014         glDisable (GL_LIGHTING);
01015         glDrawBuffer (GL_FRONT);
01016 
01017         glShadeModel (GL_SMOOTH);               <span class="comment">// Gouraud shading</span>
01018 
01019 
01020         <a class="code" href="classStIter.html#c8">RBOpenGLRenderScene</a> ();
01021 
01022 
01023         glPixelStorei(GL_PACK_ALIGNMENT, 1);
01024         glReadPixels (0, 0, camera.<a class="code" href="classCamera.html#m9">hres</a>, camera.<a class="code" href="classCamera.html#m10">vres</a>, GL_RGB, GL_UNSIGNED_BYTE, &amp;Image[0]);
01025 
01026         <span class="comment">// make the rendering context not current</span>
01027         wglMakeCurrent (NULL, NULL);
01028 
01029         <span class="comment">// delete the rendering context </span>
01030         wglDeleteContext (RC);
01031         DeleteDC (DC);
01032         DeleteObject (hDib);
01033 
01034 
01035         <a class="code" href="classVector.html">Color</a> L;
01036         <span class="keywordtype">float</span> scale = 1.0f/255.0f;
01037         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y=0; y&lt;camera.<a class="code" href="classCamera.html#m10">vres</a>; y++) {
01038                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x=0; x&lt;camera.<a class="code" href="classCamera.html#m9">hres</a>; x++) {
01039                         <span class="comment">// The OpenGL image is upside-down</span>
01040                         <span class="keywordtype">long</span> id=3*((camera.<a class="code" href="classCamera.html#m10">vres</a>-y-1)*camera.<a class="code" href="classCamera.html#m9">hres</a>+x);
01041                         L.<a class="code" href="classVector.html#m4">r</a>=Image[id]*scale;
01042                         L.<a class="code" href="classVector.html#m5">g</a>=Image[id+1]*scale;
01043                         L.<a class="code" href="classVector.html#m6">b</a>=Image[id+2]*scale;
01044                         <a class="code" href="classStIter.html#o1">m_screenBuffer</a>.<a class="code" href="classScreenBuffer.html#a6">AccumulateRadiance</a>(x,y,L);
01045                 }
01046         }
01047 }
01048 
<a name="l01049"></a><a class="code" href="classStIter.html#c8">01049</a> <span class="keywordtype">void</span>    <a class="code" href="classStIter.html#c8">StIter::RBOpenGLRenderScene</a> ()
01050 {
01051         <span class="keyword">const</span> <a class="code" href="classCamera.html">Camera</a>&amp; camera = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#m1">m_camera</a>;
01052 
01053         GLsizei width = camera.<a class="code" href="classCamera.html#m9">hres</a>;
01054         GLsizei height = camera.<a class="code" href="classCamera.html#m10">vres</a>;
01055         
01056         GLfloat aspect = (GLfloat) width / (GLfloat) height;
01057         
01058         glViewport (0, 0, width, height);
01059         glMatrixMode (GL_PROJECTION);
01060         glLoadIdentity ();
01061         gluPerspective (camera.<a class="code" href="classCamera.html#m6">vfov</a> * 2.0, aspect, camera.<a class="code" href="classCamera.html#m7">nearClip</a>, camera.<a class="code" href="classCamera.html#m8">farClip</a>);
01062         
01063         glMatrixMode (GL_MODELVIEW);
01064         glLoadIdentity ();
01065         glClear (GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
01066         gluLookAt (camera.<a class="code" href="classCamera.html#m0">eyep</a>.<a class="code" href="classVector.html#m1">x</a>, camera.<a class="code" href="classCamera.html#m0">eyep</a>.<a class="code" href="classVector.html#m2">y</a> ,camera.<a class="code" href="classCamera.html#m0">eyep</a>.<a class="code" href="classVector.html#m3">z</a>,
01067                 camera.<a class="code" href="classCamera.html#m1">lookp</a>.<a class="code" href="classVector.html#m1">x</a>, camera.<a class="code" href="classCamera.html#m1">lookp</a>.<a class="code" href="classVector.html#m2">y</a>, camera.<a class="code" href="classCamera.html#m1">lookp</a>.<a class="code" href="classVector.html#m3">z</a>,
01068                 camera.<a class="code" href="classCamera.html#m2">updir</a>.<a class="code" href="classVector.html#m1">x</a>, camera.<a class="code" href="classCamera.html#m2">updir</a>.<a class="code" href="classVector.html#m2">y</a>, camera.<a class="code" href="classCamera.html#m2">updir</a>.<a class="code" href="classVector.html#m3">z</a>);
01069         
01070         <span class="comment">// set up scene</span>
01071         glPushMatrix ();
01072         
01073         glBegin (GL_TRIANGLES);
01074         <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i=0; i&lt;<a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_1">nScenePatches</a>; i++) {
01075                 
01076                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a>* vec = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m0">a</a>;
01077                 <a class="code" href="classVector.html">Color</a>* pVertexColor = <a class="code" href="classStIter.html#o12">m_vertexColors</a> + (vec - <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_0">sceneVertices</a>);
01078                 glColor3d (pVertexColor-&gt;<a class="code" href="classVector.html#m4">r</a>, pVertexColor-&gt;<a class="code" href="classVector.html#m5">g</a>, pVertexColor-&gt;<a class="code" href="classVector.html#m6">b</a>);
01079                 glVertex3d (vec-&gt;<a class="code" href="classVector.html#m1">x</a>, vec-&gt;<a class="code" href="classVector.html#m2">y</a>, vec-&gt;<a class="code" href="classVector.html#m3">z</a>); 
01080 
01081                 vec = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m1">b</a>;
01082                 pVertexColor = <a class="code" href="classStIter.html#o12">m_vertexColors</a> + (vec - <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_0">sceneVertices</a>);
01083                 glColor3d (pVertexColor-&gt;<a class="code" href="classVector.html#m4">r</a>, pVertexColor-&gt;<a class="code" href="classVector.html#m5">g</a>, pVertexColor-&gt;<a class="code" href="classVector.html#m6">b</a> );
01084                 glVertex3d (vec-&gt;<a class="code" href="classVector.html#m1">x</a>, vec-&gt;<a class="code" href="classVector.html#m2">y</a>, vec-&gt;<a class="code" href="classVector.html#m3">z</a>); 
01085 
01086                 vec = <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z3_0">scenePatches</a>[i].<a class="code" href="classTriangle.html#m2">c</a>;
01087                 pVertexColor = <a class="code" href="classStIter.html#o12">m_vertexColors</a> + (vec - <a class="code" href="classStIter.html#o0">m_pScene</a>-&gt;<a class="code" href="classScene.html#z1_0">sceneVertices</a>);
01088                 glColor3d (pVertexColor-&gt;<a class="code" href="classVector.html#m4">r</a>, pVertexColor-&gt;<a class="code" href="classVector.html#m5">g</a>, pVertexColor-&gt;<a class="code" href="classVector.html#m6">b</a> );
01089                 glVertex3d (vec-&gt;<a class="code" href="classVector.html#m1">x</a>, vec-&gt;<a class="code" href="classVector.html#m2">y</a>, vec-&gt;<a class="code" href="classVector.html#m3">z</a>);    
01090         }
01091         glEnd ();
01092 
01093         glPopMatrix ();
01094         ::glFlush();
01095 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Feb 18 18:30:34 2003 for Stochastic Iteration for Non-diffuse Global Illumination by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
